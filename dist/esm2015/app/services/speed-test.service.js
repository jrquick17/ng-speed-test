import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Observable, of } from 'rxjs';
import { flatMap, map } from 'rxjs/operators';
import { FileDetailsModel } from '../models/file-details.model';
import { SpeedDetailsModel } from '../models/speed-details.model';
let SpeedTestService = class SpeedTestService {
    constructor() {
        this._applyCacheBuster = (path) => path + '?nnn=' + Math.random();
    }
    _download(fileDetails, iterations, allDetails) {
        return new Observable((observer) => {
            const newSpeedDetails = new SpeedDetailsModel(fileDetails.size);
            const download = new Image();
            download.onload = (a) => {
                newSpeedDetails.end();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            download.onerror = () => {
                observer.next(null);
                observer.complete();
            };
            let filePath = fileDetails.path;
            if (fileDetails.shouldBustCache) {
                filePath = this._applyCacheBuster(filePath);
            }
            newSpeedDetails.start();
            download.src = filePath;
        }).pipe(flatMap((newSpeedDetails) => {
            if (newSpeedDetails === null) {
                console.error('ng-speed-test: Error downloading file.');
            }
            else {
                if (typeof allDetails === 'undefined') {
                    allDetails = [];
                }
                allDetails.push(newSpeedDetails);
            }
            if (typeof iterations === 'undefined') {
                iterations = 3;
            }
            if (iterations === 1) {
                const count = allDetails.length;
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += allDetails[i].speedBps;
                }
                const speedBps = total / count;
                return of(speedBps);
            }
            else {
                return this._download(fileDetails, --iterations, allDetails);
            }
        }));
    }
    getBps(fileDetails, iterations, previousSpeed) {
        return new Observable((observer) => {
            window.setTimeout(() => {
                if (typeof fileDetails === 'undefined') {
                    fileDetails = new FileDetailsModel();
                }
                else {
                    if (typeof fileDetails.path === 'undefined') {
                        console.error('ng-speed-test: File path is missing.');
                        return null;
                    }
                    if (typeof fileDetails.size === 'undefined') {
                        console.error('ng-speed-test: File size is missing.');
                        return null;
                    }
                    if (typeof fileDetails.shouldBustCache === 'undefined') {
                        fileDetails.shouldBustCache = true;
                    }
                    else {
                        fileDetails.shouldBustCache = fileDetails.shouldBustCache === true;
                    }
                }
                this._download(fileDetails, iterations).subscribe((speedBps) => {
                    observer.next(speedBps);
                    observer.complete();
                });
            }, 1);
        });
    }
    getKbps() {
        return this.getBps().pipe(map((bps) => {
            return bps / 1024;
        }));
    }
    getMbps() {
        return this.getKbps().pipe(map((kpbs) => {
            return kpbs / 1024;
        }));
    }
};
SpeedTestService = tslib_1.__decorate([
    Injectable()
], SpeedTestService);
export { SpeedTestService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlZWQtdGVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctc3BlZWQtdGVzdC8iLCJzb3VyY2VzIjpbImFwcC9zZXJ2aWNlcy9zcGVlZC10ZXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsT0FBTyxFQUFDLFVBQVUsRUFBRSxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUdoRSxJQUFhLGdCQUFnQixHQUE3QixNQUFhLGdCQUFnQjtJQUMzQjtRQUlRLHNCQUFpQixHQUFHLENBQUMsSUFBVyxFQUFVLEVBQUUsQ0FBQyxJQUFJLEdBQUcsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUZwRixDQUFDO0lBSU8sU0FBUyxDQUFDLFdBQTRCLEVBQUUsVUFBa0IsRUFBRSxVQUErQjtRQUNqRyxPQUFPLElBQUksVUFBVSxDQUNuQixDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ1gsTUFBTSxlQUFlLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFaEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUU3QixRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RCLGVBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFFdEIsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDL0IsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3RCLENBQUMsQ0FBQztZQUVGLFFBQVEsQ0FB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LFFBQVEsQ0FBQyxDQUFDO29CQUN4QixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLENBQUMsQ0FDRixDQUFDO1lBQ0osQ0FBQyxFQUNELENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FDdkIsR0FBRyxDQUNELENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDTixPQUFPLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFDcEIsQ0FBQyxDQUNGLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUN4QixHQUFHLENBQ0QsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNQLE9BQU8sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNyQixDQUFDLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7QUFsSVksZ0JBQWdCO0lBRDVCLFVBQVUsRUFBRTtHQUNBLGdCQUFnQixDQWtJNUI7U0FsSVksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtPYnNlcnZhYmxlLCBvZn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2ZsYXRNYXAsIG1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtGaWxlRGV0YWlsc01vZGVsfSBmcm9tICcuLi9tb2RlbHMvZmlsZS1kZXRhaWxzLm1vZGVsJztcbmltcG9ydCB7U3BlZWREZXRhaWxzTW9kZWx9IGZyb20gJy4uL21vZGVscy9zcGVlZC1kZXRhaWxzLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNwZWVkVGVzdFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcigpIHtcblxuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlDYWNoZUJ1c3RlciA9IChwYXRoOnN0cmluZyk6IHN0cmluZyA9PiBwYXRoICsgJz9ubm49JyArIE1hdGgucmFuZG9tKCk7XG5cbiAgcHJpdmF0ZSBfZG93bmxvYWQoZmlsZURldGFpbHM6RmlsZURldGFpbHNNb2RlbCwgaXRlcmF0aW9ucz86bnVtYmVyLCBhbGxEZXRhaWxzPzpTcGVlZERldGFpbHNNb2RlbFtdKTpPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxTcGVlZERldGFpbHNNb2RlbD4oXG4gICAgICAob2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgY29uc3QgbmV3U3BlZWREZXRhaWxzID0gbmV3IFNwZWVkRGV0YWlsc01vZGVsKGZpbGVEZXRhaWxzLnNpemUpO1xuXG4gICAgICAgIGNvbnN0IGRvd25sb2FkID0gbmV3IEltYWdlKCk7XG5cbiAgICAgICAgZG93bmxvYWQub25sb2FkID0gKGEpID0+IHtcbiAgICAgICAgICBuZXdTcGVlZERldGFpbHMuZW5kKCk7XG5cbiAgICAgICAgICBvYnNlcnZlci5uZXh0KG5ld1NwZWVkRGV0YWlscyk7XG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICBkb3dubG9hZC5vbmVycm9yID0gKCkgPT4ge1xuICAgICAgICAgIG9ic2VydmVyLm5leHQobnVsbCk7XG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgZmlsZVBhdGggPSBmaWxlRGV0YWlscy5wYXRoO1xuICAgICAgICBpZiAoZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlKSB7XG4gICAgICAgICAgZmlsZVBhdGggPSB0aGlzLl9hcHBseUNhY2hlQnVzdGVyKGZpbGVQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5ld1NwZWVkRGV0YWlscy5zdGFydCgpO1xuXG4gICAgICAgIGRvd25sb2FkLnNyYyA9IGZpbGVQYXRoO1xuICAgICAgfVxuICAgICkucGlwZShcbiAgICAgIGZsYXRNYXAoXG4gICAgICAgIChuZXdTcGVlZERldGFpbHM6U3BlZWREZXRhaWxzTW9kZWx8bnVsbCkgPT4ge1xuICAgICAgICAgIGlmIChuZXdTcGVlZERldGFpbHMgPT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ25nLXNwZWVkLXRlc3Q6IEVycm9yIGRvd25sb2FkaW5nIGZpbGUuJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYWxsRGV0YWlscyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgYWxsRGV0YWlscyA9IFtdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBhbGxEZXRhaWxzLnB1c2gobmV3U3BlZWREZXRhaWxzKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdGlvbnMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBpdGVyYXRpb25zID0gMztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoaXRlcmF0aW9ucyA9PT0gMSkge1xuICAgICAgICAgICAgY29uc3QgY291bnQgPSBhbGxEZXRhaWxzLmxlbmd0aDtcbiAgICAgICAgICAgIGxldCB0b3RhbCA9IDA7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICAgICAgICB0b3RhbCArPSBhbGxEZXRhaWxzW2ldLnNwZWVkQnBzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBzcGVlZEJwcyA9IHRvdGFsIC8gY291bnQ7XG5cbiAgICAgICAgICAgIHJldHVybiBvZihzcGVlZEJwcyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kb3dubG9hZChmaWxlRGV0YWlscywgLS1pdGVyYXRpb25zLCBhbGxEZXRhaWxzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgZ2V0QnBzKGZpbGVEZXRhaWxzPzpGaWxlRGV0YWlsc01vZGVsLCBpdGVyYXRpb25zPzpudW1iZXIsIHByZXZpb3VzU3BlZWQ/Om51bWJlcik6T2JzZXJ2YWJsZTxudW1iZXJ8bnVsbD4ge1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShcbiAgICAgIChvYnNlcnZlcikgPT4ge1xuICAgICAgICB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGZpbGVEZXRhaWxzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICBmaWxlRGV0YWlscyA9IG5ldyBGaWxlRGV0YWlsc01vZGVsKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAodHlwZW9mIGZpbGVEZXRhaWxzLnBhdGggPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignbmctc3BlZWQtdGVzdDogRmlsZSBwYXRoIGlzIG1pc3NpbmcuJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgZmlsZURldGFpbHMuc2l6ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCduZy1zcGVlZC10ZXN0OiBGaWxlIHNpemUgaXMgbWlzc2luZy4nKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUgPSBmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUgPT09IHRydWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5fZG93bmxvYWQoZmlsZURldGFpbHMsIGl0ZXJhdGlvbnMpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgKHNwZWVkQnBzKSA9PiB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChzcGVlZEJwcyk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIDFcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZ2V0S2JwcygpOk9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QnBzKCkucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGJwcykgPT4ge1xuICAgICAgICAgIHJldHVybiBicHMgLyAxMDI0O1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGdldE1icHMoKTpPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLmdldEticHMoKS5waXBlKFxuICAgICAgbWFwKFxuICAgICAgICAoa3BicykgPT4ge1xuICAgICAgICAgIHJldHVybiBrcGJzIC8gMTAyNDtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==