import { Injectable } from '@angular/core';
import { fromEvent, merge, Observable, of } from 'rxjs';
import { map, mergeMap } from 'rxjs/operators';
import { SpeedTestFileModel } from '../models/speed-test-file.model';
import { SpeedTestResultsModel } from '../models/speed-test-results.model';
import { SpeedTestSettingsModel } from '../models/speed-test-settings.model';
export class SpeedTestService {
    constructor() {
        this._applyCacheBuster = (path) => path + '?nnn=' + Math.random();
    }
    _download(settings, allDetails) {
        return new Observable((observer) => {
            const newSpeedDetails = new SpeedTestResultsModel(settings.file.size);
            const download = new Image();
            download.onload = () => {
                newSpeedDetails.end();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            download.onerror = () => {
                newSpeedDetails.error();
                let delay = 0;
                if (settings.iterations !== 1) {
                    delay = settings.retryDelay;
                }
                window.setTimeout(() => {
                    observer.next(newSpeedDetails);
                    observer.complete();
                }, delay);
            };
            let filePath = settings.file.path;
            if (settings.file.shouldBustCache) {
                filePath = this._applyCacheBuster(filePath);
            }
            newSpeedDetails.start();
            download.src = filePath;
        }).pipe(mergeMap((newSpeedDetails) => {
            if (typeof allDetails === 'undefined') {
                allDetails = [];
            }
            allDetails.push(newSpeedDetails);
            if (settings.iterations === 1) {
                const count = allDetails.length;
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += allDetails[i].speedBps;
                }
                const speedBps = total / count;
                return of(speedBps);
            }
            else {
                settings.iterations--;
                return this._download(settings, allDetails);
            }
        }));
    }
    getBps(settings) {
        return new Observable((observer) => {
            window.setTimeout(() => {
                const defaultSettings = new SpeedTestSettingsModel();
                if (typeof settings === 'undefined') {
                    settings = Object.assign({}, defaultSettings);
                }
                else {
                    if (typeof settings.iterations === 'undefined') {
                        settings.iterations = defaultSettings.iterations;
                    }
                    if (typeof settings.file === 'undefined') {
                        settings.file = defaultSettings.file;
                    }
                    else {
                        const defaultFileSettings = new SpeedTestFileModel();
                        if (typeof settings.file.path === 'undefined') {
                            console.error('ng-speed-test: File path is missing.');
                            return null;
                        }
                        if (typeof settings.file.size === 'undefined') {
                            console.error('ng-speed-test: File size is missing.');
                            return null;
                        }
                        if (typeof settings.file.shouldBustCache === 'undefined') {
                            settings.file.shouldBustCache = defaultFileSettings.shouldBustCache;
                        }
                        if (typeof settings.retryDelay === 'undefined') {
                            settings.retryDelay = defaultSettings.retryDelay;
                        }
                    }
                }
                this._download(Object.assign({}, settings)).subscribe((speedBps) => {
                    observer.next(speedBps);
                    observer.complete();
                });
            }, 1);
        });
    }
    getKbps(settings) {
        return this.getBps(settings).pipe(map((bps) => {
            return bps / 1024;
        }));
    }
    getMbps(settings) {
        return this.getKbps(settings).pipe(map((kpbs) => {
            return kpbs / 1024;
        }));
    }
    isOnline() {
        return merge(fromEvent(window, 'offline').pipe(map(() => false)), fromEvent(window, 'online').pipe(map(() => true)), new Observable((sub) => {
            sub.next(navigator.onLine);
            sub.complete();
        }));
    }
}
SpeedTestService.decorators = [
    { type: Injectable }
];
SpeedTestService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlZWQtdGVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9qcnF1aWNrL2RldmVsb3BtZW50L2VuY291bnRpbmcvbmctc3BlZWQtdGVzdC9zcmMvIiwic291cmNlcyI6WyJhcHAvc2VydmljZXMvc3BlZWQtdGVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsT0FBTyxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFZLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNoRSxPQUFPLEVBQUMsR0FBRyxFQUFFLFFBQVEsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGlDQUFpQyxDQUFDO0FBQ25FLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBQ3pFLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBRzNFLE1BQU0sT0FBTyxnQkFBZ0I7SUFDM0I7UUFJUSxzQkFBaUIsR0FBRyxDQUFDLElBQVcsRUFBVSxFQUFFLENBQUMsSUFBSSxHQUFHLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFGcEYsQ0FBQztJQUlPLFNBQVMsQ0FBQyxRQUErQixFQUFFLFVBQW1DO1FBQ3BGLE9BQU8sSUFBSSxVQUFVLENBQ25CLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDWCxNQUFNLGVBQWUsR0FBRyxJQUFJLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFdEUsTUFBTSxRQUFRLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztZQUU3QixRQUFRLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtnQkFDckIsZUFBZSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUV0QixRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUMvQixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDdEIsQ0FBQyxDQUFDO1lBRUYsUUFBUSxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUU7Z0JBQ3RCLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFFeEIsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO2dCQUNkLElBQUksUUFBUSxDQUFDLFVBQVUsS0FBSyxDQUFDLEVBQUU7b0JBQzdCLEtBQUssR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDO2lCQUM3QjtnQkFFRCxNQUFNLENBQUMsVUFBVSxDQUNmLEdBQUcsRUFBRTtvQkFDSCxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO29CQUMvQixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLENBQUMsRUFDRCxLQUFLLENBQ04sQ0FBQztZQUNKLENBQUMsQ0FBQztZQUVGLElBQUksUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ2xDLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBQ2pDLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDN0M7WUFFRCxlQUFlLENBQUMsS0FBSyxFQUFFLENBQUM7WUFFeEIsUUFBUSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUM7UUFDMUIsQ0FBQyxDQUNGLENBQUMsSUFBSSxDQUNKLFFBQVEsQ0FDTixDQUFDLGVBQTBDLEVBQUUsRUFBRTtZQUM3QyxJQUFJLE9BQU8sVUFBVSxLQUFLLFdBQVcsRUFBRTtnQkFDckMsVUFBVSxHQUFHLEVBQUUsQ0FBQzthQUNqQjtZQUVELFVBQVUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFFakMsSUFBSSxRQUFRLENBQUMsVUFBVSxLQUFLLENBQUMsRUFBRTtnQkFDN0IsTUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztnQkFDaEMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO2dCQUVkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQzlCLEtBQUssSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO2lCQUNqQztnQkFFRCxNQUFNLFFBQVEsR0FBRyxLQUFLLEdBQUcsS0FBSyxDQUFDO2dCQUUvQixPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNyQjtpQkFBTTtnQkFDTCxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBRXRCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7YUFDN0M7UUFDSCxDQUFDLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELE1BQU0sQ0FBQyxRQUFnQztRQUNyQyxPQUFPLElBQUksVUFBVSxDQUNuQixDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ1gsTUFBTSxDQUFDLFVBQVUsQ0FDZixHQUFHLEVBQUU7Z0JBQ0gsTUFBTSxlQUFlLEdBQUcsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO2dCQUNyRCxJQUFJLE9BQU8sUUFBUSxLQUFLLFdBQVcsRUFBRTtvQkFDbkMsUUFBUSxxQkFBUSxlQUFlLENBQUUsQ0FBQztpQkFDbkM7cUJBQU07b0JBQ0wsSUFBSSxPQUFPLFFBQVEsQ0FBQyxVQUFVLEtBQUssV0FBVyxFQUFFO3dCQUM5QyxRQUFRLENBQUMsVUFBVSxHQUFHLGVBQWUsQ0FBQyxVQUFVLENBQUM7cUJBQ2xEO29CQUVELElBQUksT0FBTyxRQUFRLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTt3QkFDeEMsUUFBUSxDQUFDLElBQUksR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDO3FCQUN0Qzt5QkFBTTt3QkFDTCxNQUFNLG1CQUFtQixHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQzt3QkFFckQsSUFBSSxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTs0QkFDN0MsT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDOzRCQUV0RCxPQUFPLElBQUksQ0FBQzt5QkFDYjt3QkFFRCxJQUFJLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFOzRCQUM3QyxPQUFPLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7NEJBRXRELE9BQU8sSUFBSSxDQUFDO3lCQUNiO3dCQUVELElBQUksT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsS0FBSyxXQUFXLEVBQUU7NEJBQ3hELFFBQVEsQ0FBQyxJQUFJLENBQUMsZUFBZSxHQUFHLG1CQUFtQixDQUFDLGVBQWUsQ0FBQzt5QkFDckU7d0JBRUQsSUFBSSxPQUFPLFFBQVEsQ0FBQyxVQUFVLEtBQUssV0FBVyxFQUFFOzRCQUM5QyxRQUFRLENBQUMsVUFBVSxHQUFHLGVBQWUsQ0FBQyxVQUFVLENBQUM7eUJBQ2xEO3FCQUNGO2lCQUNGO2dCQUVELElBQUksQ0FBQyxTQUFTLG1CQUFNLFFBQVEsRUFBRyxDQUFDLFNBQVMsQ0FDdkMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtvQkFDWCxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO29CQUN4QixRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3RCLENBQUMsQ0FDRixDQUFDO1lBQ0osQ0FBQyxFQUNELENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxDQUFDLFFBQWdDO1FBQ3RDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQy9CLEdBQUcsQ0FDRCxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ04sT0FBTyxHQUFHLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxDQUFDLFFBQWdDO1FBQ3RDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQ2hDLEdBQUcsQ0FDRCxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ1AsT0FBTyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sS0FBSyxDQUNWLFNBQVMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUMvQixHQUFHLENBQ0QsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUNaLENBQ0YsRUFDRCxTQUFTLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FDOUIsR0FBRyxDQUNELEdBQUcsRUFBRSxDQUFDLElBQUksQ0FDWCxDQUNGLEVBQ0QsSUFBSSxVQUFVLENBQ1osQ0FBQyxHQUFxQixFQUFFLEVBQUU7WUFDeEIsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDM0IsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2pCLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDOzs7WUExS0YsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7ZnJvbUV2ZW50LCBtZXJnZSwgT2JzZXJ2YWJsZSwgT2JzZXJ2ZXIsIG9mfSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwLCBtZXJnZU1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1NwZWVkVGVzdEZpbGVNb2RlbH0gZnJvbSAnLi4vbW9kZWxzL3NwZWVkLXRlc3QtZmlsZS5tb2RlbCc7XG5pbXBvcnQge1NwZWVkVGVzdFJlc3VsdHNNb2RlbH0gZnJvbSAnLi4vbW9kZWxzL3NwZWVkLXRlc3QtcmVzdWx0cy5tb2RlbCc7XG5pbXBvcnQge1NwZWVkVGVzdFNldHRpbmdzTW9kZWx9IGZyb20gJy4uL21vZGVscy9zcGVlZC10ZXN0LXNldHRpbmdzLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNwZWVkVGVzdFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcigpIHtcblxuICB9XG5cbiAgcHJpdmF0ZSBfYXBwbHlDYWNoZUJ1c3RlciA9IChwYXRoOnN0cmluZyk6IHN0cmluZyA9PiBwYXRoICsgJz9ubm49JyArIE1hdGgucmFuZG9tKCk7XG5cbiAgcHJpdmF0ZSBfZG93bmxvYWQoc2V0dGluZ3M6U3BlZWRUZXN0U2V0dGluZ3NNb2RlbCwgYWxsRGV0YWlscz86U3BlZWRUZXN0UmVzdWx0c01vZGVsW10pOk9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPFNwZWVkVGVzdFJlc3VsdHNNb2RlbD4oXG4gICAgICAob2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgY29uc3QgbmV3U3BlZWREZXRhaWxzID0gbmV3IFNwZWVkVGVzdFJlc3VsdHNNb2RlbChzZXR0aW5ncy5maWxlLnNpemUpO1xuXG4gICAgICAgIGNvbnN0IGRvd25sb2FkID0gbmV3IEltYWdlKCk7XG5cbiAgICAgICAgZG93bmxvYWQub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIG5ld1NwZWVkRGV0YWlscy5lbmQoKTtcblxuICAgICAgICAgIG9ic2VydmVyLm5leHQobmV3U3BlZWREZXRhaWxzKTtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGRvd25sb2FkLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICAgICAgbmV3U3BlZWREZXRhaWxzLmVycm9yKCk7XG5cbiAgICAgICAgICBsZXQgZGVsYXkgPSAwO1xuICAgICAgICAgIGlmIChzZXR0aW5ncy5pdGVyYXRpb25zICE9PSAxKSB7XG4gICAgICAgICAgICBkZWxheSA9IHNldHRpbmdzLnJldHJ5RGVsYXk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgIG9ic2VydmVyLm5leHQobmV3U3BlZWREZXRhaWxzKTtcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkZWxheVxuICAgICAgICAgICk7XG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IGZpbGVQYXRoID0gc2V0dGluZ3MuZmlsZS5wYXRoO1xuICAgICAgICBpZiAoc2V0dGluZ3MuZmlsZS5zaG91bGRCdXN0Q2FjaGUpIHtcbiAgICAgICAgICBmaWxlUGF0aCA9IHRoaXMuX2FwcGx5Q2FjaGVCdXN0ZXIoZmlsZVBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV3U3BlZWREZXRhaWxzLnN0YXJ0KCk7XG5cbiAgICAgICAgZG93bmxvYWQuc3JjID0gZmlsZVBhdGg7XG4gICAgICB9XG4gICAgKS5waXBlKFxuICAgICAgbWVyZ2VNYXAoXG4gICAgICAgIChuZXdTcGVlZERldGFpbHM6U3BlZWRUZXN0UmVzdWx0c01vZGVsfG51bGwpID0+IHtcbiAgICAgICAgICBpZiAodHlwZW9mIGFsbERldGFpbHMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBhbGxEZXRhaWxzID0gW107XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYWxsRGV0YWlscy5wdXNoKG5ld1NwZWVkRGV0YWlscyk7XG5cbiAgICAgICAgICBpZiAoc2V0dGluZ3MuaXRlcmF0aW9ucyA9PT0gMSkge1xuICAgICAgICAgICAgY29uc3QgY291bnQgPSBhbGxEZXRhaWxzLmxlbmd0aDtcbiAgICAgICAgICAgIGxldCB0b3RhbCA9IDA7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICAgICAgICB0b3RhbCArPSBhbGxEZXRhaWxzW2ldLnNwZWVkQnBzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBzcGVlZEJwcyA9IHRvdGFsIC8gY291bnQ7XG5cbiAgICAgICAgICAgIHJldHVybiBvZihzcGVlZEJwcyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNldHRpbmdzLml0ZXJhdGlvbnMtLTtcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Rvd25sb2FkKHNldHRpbmdzLCBhbGxEZXRhaWxzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgZ2V0QnBzKHNldHRpbmdzPzpTcGVlZFRlc3RTZXR0aW5nc01vZGVsKTpPYnNlcnZhYmxlPG51bWJlcnxudWxsPiB7XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKFxuICAgICAgKG9ic2VydmVyKSA9PiB7XG4gICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRTZXR0aW5ncyA9IG5ldyBTcGVlZFRlc3RTZXR0aW5nc01vZGVsKCk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICBzZXR0aW5ncyA9IHsgLi4uZGVmYXVsdFNldHRpbmdzIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzLml0ZXJhdGlvbnMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgc2V0dGluZ3MuaXRlcmF0aW9ucyA9IGRlZmF1bHRTZXR0aW5ncy5pdGVyYXRpb25zO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5maWxlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHNldHRpbmdzLmZpbGUgPSBkZWZhdWx0U2V0dGluZ3MuZmlsZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0RmlsZVNldHRpbmdzID0gbmV3IFNwZWVkVGVzdEZpbGVNb2RlbCgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5maWxlLnBhdGggPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCduZy1zcGVlZC10ZXN0OiBGaWxlIHBhdGggaXMgbWlzc2luZy4nKTtcblxuICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5maWxlLnNpemUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCduZy1zcGVlZC10ZXN0OiBGaWxlIHNpemUgaXMgbWlzc2luZy4nKTtcblxuICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5maWxlLnNob3VsZEJ1c3RDYWNoZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmZpbGUuc2hvdWxkQnVzdENhY2hlID0gZGVmYXVsdEZpbGVTZXR0aW5ncy5zaG91bGRCdXN0Q2FjaGU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5yZXRyeURlbGF5ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgc2V0dGluZ3MucmV0cnlEZWxheSA9IGRlZmF1bHRTZXR0aW5ncy5yZXRyeURlbGF5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl9kb3dubG9hZCh7IC4uLnNldHRpbmdzIH0pLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgKHNwZWVkQnBzKSA9PiB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChzcGVlZEJwcyk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIDFcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZ2V0S2JwcyhzZXR0aW5ncz86U3BlZWRUZXN0U2V0dGluZ3NNb2RlbCk6T2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRCcHMoc2V0dGluZ3MpLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgIChicHMpID0+IHtcbiAgICAgICAgICByZXR1cm4gYnBzIC8gMTAyNDtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBnZXRNYnBzKHNldHRpbmdzPzpTcGVlZFRlc3RTZXR0aW5nc01vZGVsKTpPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLmdldEticHMoc2V0dGluZ3MpLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgIChrcGJzKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGtwYnMgLyAxMDI0O1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGlzT25saW5lKCk6T2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG1lcmdlPGJvb2xlYW4+KFxuICAgICAgZnJvbUV2ZW50KHdpbmRvdywgJ29mZmxpbmUnKS5waXBlKFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKCkgPT4gZmFsc2VcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIGZyb21FdmVudCh3aW5kb3csICdvbmxpbmUnKS5waXBlKFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKCkgPT4gdHJ1ZVxuICAgICAgICApXG4gICAgICApLFxuICAgICAgbmV3IE9ic2VydmFibGUoXG4gICAgICAgIChzdWI6T2JzZXJ2ZXI8Ym9vbGVhbj4pID0+IHtcbiAgICAgICAgICBzdWIubmV4dChuYXZpZ2F0b3Iub25MaW5lKTtcbiAgICAgICAgICBzdWIuY29tcGxldGUoKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==