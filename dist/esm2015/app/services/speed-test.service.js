import { Injectable } from '@angular/core';
import { Observable, of } from 'rxjs';
import { mergeMap, map } from 'rxjs/operators';
import { FileDetailsModel } from '../models/file-details.model';
import { SpeedDetailsModel } from '../models/speed-details.model';
export class SpeedTestService {
    constructor() {
        this._applyCacheBuster = (path) => path + '?nnn=' + Math.random();
    }
    _download(iterations, fileDetails, allDetails) {
        return new Observable((observer) => {
            const newSpeedDetails = new SpeedDetailsModel(fileDetails.size);
            const download = new Image();
            download.onload = () => {
                newSpeedDetails.end();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            download.onerror = () => {
                newSpeedDetails.error();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            let filePath = fileDetails.path;
            if (fileDetails.shouldBustCache) {
                filePath = this._applyCacheBuster(filePath);
            }
            newSpeedDetails.start();
            download.src = filePath;
        }).pipe(mergeMap((newSpeedDetails) => {
            if (typeof allDetails === 'undefined') {
                allDetails = [];
            }
            allDetails.push(newSpeedDetails);
            if (typeof iterations === 'undefined') {
                iterations = 3;
            }
            if (iterations === 1) {
                const count = allDetails.length;
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += allDetails[i].speedBps;
                }
                const speedBps = total / count;
                return of(speedBps);
            }
            else {
                return this._download(--iterations, fileDetails, allDetails);
            }
        }));
    }
    getBps(iterations, fileDetails) {
        return new Observable((observer) => {
            window.setTimeout(() => {
                if (typeof fileDetails === 'undefined') {
                    fileDetails = new FileDetailsModel();
                }
                else {
                    if (typeof fileDetails.path === 'undefined') {
                        console.error('ng-speed-test: File path is missing.');
                        return null;
                    }
                    if (typeof fileDetails.size === 'undefined') {
                        console.error('ng-speed-test: File size is missing.');
                        return null;
                    }
                    if (typeof fileDetails.shouldBustCache === 'undefined') {
                        fileDetails.shouldBustCache = true;
                    }
                    else {
                        fileDetails.shouldBustCache = fileDetails.shouldBustCache === true;
                    }
                }
                this._download(iterations, fileDetails).subscribe((speedBps) => {
                    observer.next(speedBps);
                    observer.complete();
                });
            }, 1);
        });
    }
    getKbps(iterations, fileDetails) {
        return this.getBps(iterations, fileDetails).pipe(map((bps) => {
            return bps / 1024;
        }));
    }
    getMbps(iterations, fileDetails) {
        return this.getKbps(iterations, fileDetails).pipe(map((kpbs) => {
            return kpbs / 1024;
        }));
    }
}
SpeedTestService.decorators = [
    { type: Injectable }
];
SpeedTestService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlZWQtdGVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9qcnF1aWNrL2RldmVsb3BtZW50L2VuY291bnRpbmcvbmctc3BlZWQtdGVzdC9zcmMvIiwic291cmNlcyI6WyJhcHAvc2VydmljZXMvc3BlZWQtdGVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsT0FBTyxFQUFDLFVBQVUsRUFBRSxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUdoRSxNQUFNLE9BQU8sZ0JBQWdCO0lBQzNCO1FBSVEsc0JBQWlCLEdBQUcsQ0FBQyxJQUFXLEVBQVUsRUFBRSxDQUFDLElBQUksR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBRnBGLENBQUM7SUFJTyxTQUFTLENBQUMsVUFBa0IsRUFBRSxXQUE2QixFQUFFLFVBQStCO1FBQ2xHLE9BQU8sSUFBSSxVQUFVLENBQ25CLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDWCxNQUFNLGVBQWUsR0FBRyxJQUFJLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVoRSxNQUFNLFFBQVEsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1lBRTdCLFFBQVEsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO2dCQUNyQixlQUFlLENBQUMsR0FBRyxFQUFFLENBQUM7Z0JBRXRCLFFBQVEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQy9CLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN0QixDQUFDLENBQUM7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Q0FDRixDQUFDO1lBQ0osQ0FBQyxFQUNELENBQUMsQ0FDRixDQUFDO1FBQ0osQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxDQUFDLFVBQWtCLEVBQUUsV0FBNkI7UUFDdkQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQzlDLEdBQUcsQ0FDRCxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ04sT0FBTyxHQUFHLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxDQUFDLFVBQWtCLEVBQUUsV0FBNkI7UUFDdkQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQy9DLEdBQUcsQ0FDRCxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ1AsT0FBTyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLENBQUMsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDOzs7WUFoSUYsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttZXJnZU1hcCwgbWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0ZpbGVEZXRhaWxzTW9kZWx9IGZyb20gJy4uL21vZGVscy9maWxlLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHtTcGVlZERldGFpbHNNb2RlbH0gZnJvbSAnLi4vbW9kZWxzL3NwZWVkLWRldGFpbHMubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3BlZWRUZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuXG4gIH1cblxuICBwcml2YXRlIF9hcHBseUNhY2hlQnVzdGVyID0gKHBhdGg6c3RyaW5nKTogc3RyaW5nID0+IHBhdGggKyAnP25ubj0nICsgTWF0aC5yYW5kb20oKTtcblxuICBwcml2YXRlIF9kb3dubG9hZChpdGVyYXRpb25zPzpudW1iZXIsIGZpbGVEZXRhaWxzPzpGaWxlRGV0YWlsc01vZGVsLCBhbGxEZXRhaWxzPzpTcGVlZERldGFpbHNNb2RlbFtdKTpPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxTcGVlZERldGFpbHNNb2RlbD4oXG4gICAgICAob2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgY29uc3QgbmV3U3BlZWREZXRhaWxzID0gbmV3IFNwZWVkRGV0YWlsc01vZGVsKGZpbGVEZXRhaWxzLnNpemUpO1xuXG4gICAgICAgIGNvbnN0IGRvd25sb2FkID0gbmV3IEltYWdlKCk7XG5cbiAgICAgICAgZG93bmxvYWQub25sb2FkID0gKCkgPT4ge1xuICAgICAgICAgIG5ld1NwZWVkRGV0YWlscy5lbmQoKTtcblxuICAgICAgICAgIG9ic2VydmVyLm5leHQobmV3U3BlZWREZXRhaWxzKTtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGRvd25sb2FkLm9uZXJyb3IgPSAoKSA9PiB7XG4gICAgICAgICAgbmV3U3BlZWREZXRhaWxzLmVycm9yKCk7XG5cbiAgICAgICAgICBvYnNlcnZlci5uZXh0KG5ld1NwZWVkRGV0YWlscyk7XG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgZmlsZVBhdGggPSBmaWxlRGV0YWlscy5wYXRoO1xuICAgICAgICBpZiAoZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlKSB7XG4gICAgICAgICAgZmlsZVBhdGggPSB0aGlzLl9hcHBseUNhY2hlQnVzdGVyKGZpbGVQYXRoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5ld1NwZWVkRGV0YWlscy5zdGFydCgpO1xuXG4gICAgICAgIGRvd25sb2FkLnNyYyA9IGZpbGVQYXRoO1xuICAgICAgfVxuICAgICkucGlwZShcbiAgICAgIG1lcmdlTWFwKFxuICAgICAgICAobmV3U3BlZWREZXRhaWxzOlNwZWVkRGV0YWlsc01vZGVsfG51bGwpID0+IHtcbiAgICAgICAgICBpZiAodHlwZW9mIGFsbERldGFpbHMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBhbGxEZXRhaWxzID0gW107XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYWxsRGV0YWlscy5wdXNoKG5ld1NwZWVkRGV0YWlscyk7XG5cbiAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdGlvbnMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBpdGVyYXRpb25zID0gMztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoaXRlcmF0aW9ucyA9PT0gMSkge1xuICAgICAgICAgICAgY29uc3QgY291bnQgPSBhbGxEZXRhaWxzLmxlbmd0aDtcbiAgICAgICAgICAgIGxldCB0b3RhbCA9IDA7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICAgICAgICB0b3RhbCArPSBhbGxEZXRhaWxzW2ldLnNwZWVkQnBzO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBzcGVlZEJwcyA9IHRvdGFsIC8gY291bnQ7XG5cbiAgICAgICAgICAgIHJldHVybiBvZihzcGVlZEJwcyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9kb3dubG9hZCgtLWl0ZXJhdGlvbnMsIGZpbGVEZXRhaWxzLCBhbGxEZXRhaWxzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgZ2V0QnBzKGl0ZXJhdGlvbnM/Om51bWJlciwgZmlsZURldGFpbHM/OkZpbGVEZXRhaWxzTW9kZWwpOk9ic2VydmFibGU8bnVtYmVyfG51bGw+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoXG4gICAgICAob2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBmaWxlRGV0YWlscyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgZmlsZURldGFpbHMgPSBuZXcgRmlsZURldGFpbHNNb2RlbCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmaWxlRGV0YWlscy5wYXRoID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ25nLXNwZWVkLXRlc3Q6IEZpbGUgcGF0aCBpcyBtaXNzaW5nLicpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZiAodHlwZW9mIGZpbGVEZXRhaWxzLnNpemUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignbmctc3BlZWQtdGVzdDogRmlsZSBzaXplIGlzIG1pc3NpbmcuJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGZpbGVEZXRhaWxzLnNob3VsZEJ1c3RDYWNoZSA9IHRydWU7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlID0gZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlID09PSB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX2Rvd25sb2FkKGl0ZXJhdGlvbnMsIGZpbGVEZXRhaWxzKS5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgIChzcGVlZEJwcykgPT4ge1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoc3BlZWRCcHMpO1xuICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAxXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGdldEticHMoaXRlcmF0aW9ucz86bnVtYmVyLCBmaWxlRGV0YWlscz86RmlsZURldGFpbHNNb2RlbCk6T2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRCcHMoaXRlcmF0aW9ucywgZmlsZURldGFpbHMpLnBpcGUoXG4gICAgICBtYXAoXG4gICAgICAgIChicHMpID0+IHtcbiAgICAgICAgICByZXR1cm4gYnBzIC8gMTAyNDtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBnZXRNYnBzKGl0ZXJhdGlvbnM/Om51bWJlciwgZmlsZURldGFpbHM/OkZpbGVEZXRhaWxzTW9kZWwpOk9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0S2JwcyhpdGVyYXRpb25zLCBmaWxlRGV0YWlscykucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGtwYnMpID0+IHtcbiAgICAgICAgICByZXR1cm4ga3BicyAvIDEwMjQ7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG59XG4iXX0=