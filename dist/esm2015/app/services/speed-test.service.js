import { Injectable } from '@angular/core';
import { fromEvent, merge, Observable, of } from 'rxjs';
import { mergeMap, map } from 'rxjs/operators';
import { SpeedTestFileModel } from '../models/speed-test-file.model';
import { SpeedTestResultsModel } from '../models/speed-test-results.model';
import { SpeedTestSettingsModel } from '../models/speed-test-settings.model';
import { deepCopy } from '@angular-devkit/core';
export class SpeedTestService {
    constructor() {
        this._applyCacheBuster = (path) => path + '?nnn=' + Math.random();
    }
    _download(settings, allDetails) {
        return new Observable((observer) => {
            const newSpeedDetails = new SpeedTestResultsModel(settings.file.size);
            const download = new Image();
            download.onload = () => {
                newSpeedDetails.end();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            download.onerror = () => {
                newSpeedDetails.error();
                let delay = 0;
                if (settings.iterations !== 1) {
                    delay = settings.retryDelay;
                }
                window.setTimeout(() => {
                    observer.next(newSpeedDetails);
                    observer.complete();
                }, delay);
            };
            let filePath = settings.file.path;
            if (settings.file.shouldBustCache) {
                filePath = this._applyCacheBuster(filePath);
            }
            newSpeedDetails.start();
            download.src = filePath;
        }).pipe(mergeMap((newSpeedDetails) => {
            if (typeof allDetails === 'undefined') {
                allDetails = [];
            }
            allDetails.push(newSpeedDetails);
            if (settings.iterations === 1) {
                const count = allDetails.length;
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += allDetails[i].speedBps;
                }
                const speedBps = total / count;
                return of(speedBps);
            }
            else {
                settings.iterations--;
                return this._download(settings, allDetails);
            }
        }));
    }
    getBps(settings) {
        return new Observable((observer) => {
            window.setTimeout(() => {
                const defaultSettings = new SpeedTestSettingsModel();
                if (typeof settings.iterations === 'undefined') {
                    settings.iterations = defaultSettings.iterations;
                }
                if (typeof settings.file === 'undefined') {
                    settings.file = defaultSettings.file;
                }
                else {
                    const defaultFileSettings = new SpeedTestFileModel();
                    if (typeof settings.file.path === 'undefined') {
                        console.error('ng-speed-test: File path is missing.');
                        return null;
                    }
                    if (typeof settings.file.size === 'undefined') {
                        console.error('ng-speed-test: File size is missing.');
                        return null;
                    }
                    if (typeof settings.file.shouldBustCache === 'undefined') {
                        settings.file.shouldBustCache = defaultFileSettings.shouldBustCache;
                    }
                    if (typeof settings.retryDelay === 'undefined') {
                        settings.retryDelay = defaultSettings.retryDelay;
                    }
                }
                this._download(deepCopy(settings)).subscribe((speedBps) => {
                    observer.next(speedBps);
                    observer.complete();
                });
            }, 1);
        });
    }
    getKbps(settings) {
        return this.getBps(settings).pipe(map((bps) => {
            return bps / 1024;
        }));
    }
    getMbps(settings) {
        return this.getKbps(settings).pipe(map((kpbs) => {
            return kpbs / 1024;
        }));
    }
    isOnline() {
        return merge(fromEvent(window, 'offline').pipe(map(() => false)), fromEvent(window, 'online').pipe(map(() => true)), new Observable((sub) => {
            sub.next(navigator.onLine);
            sub.complete();
        }));
    }
}
SpeedTestService.decorators = [
    { type: Injectable }
];
SpeedTestService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlZWQtdGVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9qcnF1aWNrL2RldmVsb3BtZW50L2VuY291bnRpbmcvbmctc3BlZWQtdGVzdC9zcmMvIiwic291cmNlcyI6WyJhcHAvc2VydmljZXMvc3BlZWQtdGVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsT0FBTyxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFZLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNoRSxPQUFPLEVBQUMsUUFBUSxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGlDQUFpQyxDQUFDO0FBQ25FLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLG9DQUFvQyxDQUFDO0FBQ3pFLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBQzNFLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxzQkFBc0IsQ0FBQztBQUc5QyxNQUFNLE9BQU8sZ0JBQWdCO0lBQzNCO1FBSVEsc0JBQWlCLEdBQUcsQ0FBQyxJQUFXLEVBQVUsRUFBRSxDQUFDLElBQUksR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBRnBGLENBQUM7SUFJTyxTQUFTLENBQUMsUUFBK0IsRUFBRSxVQUFtQztRQUNwRixPQUFPLElBQUksVUFBVSxDQUNuQixDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQ1gsTUFBTSxlQUFlLEdBQUcsSUFBSSxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRXRFLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7WUFFN0IsUUFBUSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7Z0JBQ3JCLGVBQWUsQ0FB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LEVBQUU7WUFDUCxPQUFPLElBQUksR0FBRyxJQUFJLENBQUM7UUFDckIsQ0FBQyxDQUNGLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxRQUFRO1FBQ04sT0FBTyxLQUFLLENBQ1YsU0FBUyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQy9CLEdBQUcsQ0FDRCxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQ1osQ0FDRixFQUNELFNBQVMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUM5QixHQUFHLENBQ0QsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUNYLENBQ0YsRUFDRCxJQUFJLFVBQVUsQ0FDWixDQUFDLEdBQXFCLEVBQUUsRUFBRTtZQUN4QixHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQixHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakIsQ0FBQyxDQUNGLENBQ0YsQ0FBQztJQUNKLENBQUM7OztZQXZLRixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtmcm9tRXZlbnQsIG1lcmdlLCBPYnNlcnZhYmxlLCBPYnNlcnZlciwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttZXJnZU1hcCwgbWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7U3BlZWRUZXN0RmlsZU1vZGVsfSBmcm9tICcuLi9tb2RlbHMvc3BlZWQtdGVzdC1maWxlLm1vZGVsJztcbmltcG9ydCB7U3BlZWRUZXN0UmVzdWx0c01vZGVsfSBmcm9tICcuLi9tb2RlbHMvc3BlZWQtdGVzdC1yZXN1bHRzLm1vZGVsJztcbmltcG9ydCB7U3BlZWRUZXN0U2V0dGluZ3NNb2RlbH0gZnJvbSAnLi4vbW9kZWxzL3NwZWVkLXRlc3Qtc2V0dGluZ3MubW9kZWwnO1xuaW1wb3J0IHtkZWVwQ29weX0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3BlZWRUZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuXG4gIH1cblxuICBwcml2YXRlIF9hcHBseUNhY2hlQnVzdGVyID0gKHBhdGg6c3RyaW5nKTogc3RyaW5nID0+IHBhdGggKyAnP25ubj0nICsgTWF0aC5yYW5kb20oKTtcblxuICBwcml2YXRlIF9kb3dubG9hZChzZXR0aW5nczpTcGVlZFRlc3RTZXR0aW5nc01vZGVsLCBhbGxEZXRhaWxzPzpTcGVlZFRlc3RSZXN1bHRzTW9kZWxbXSk6T2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8U3BlZWRUZXN0UmVzdWx0c01vZGVsPihcbiAgICAgIChvYnNlcnZlcikgPT4ge1xuICAgICAgICBjb25zdCBuZXdTcGVlZERldGFpbHMgPSBuZXcgU3BlZWRUZXN0UmVzdWx0c01vZGVsKHNldHRpbmdzLmZpbGUuc2l6ZSk7XG5cbiAgICAgICAgY29uc3QgZG93bmxvYWQgPSBuZXcgSW1hZ2UoKTtcblxuICAgICAgICBkb3dubG9hZC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgbmV3U3BlZWREZXRhaWxzLmVuZCgpO1xuXG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChuZXdTcGVlZERldGFpbHMpO1xuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZG93bmxvYWQub25lcnJvciA9ICgpID0+IHtcbiAgICAgICAgICBuZXdTcGVlZERldGFpbHMuZXJyb3IoKTtcblxuICAgICAgICAgIGxldCBkZWxheSA9IDA7XG4gICAgICAgICAgaWYgKHNldHRpbmdzLml0ZXJhdGlvbnMgIT09IDEpIHtcbiAgICAgICAgICAgIGRlbGF5ID0gc2V0dGluZ3MucmV0cnlEZWxheTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChuZXdTcGVlZERldGFpbHMpO1xuICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRlbGF5XG4gICAgICAgICAgKTtcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgZmlsZVBhdGggPSBzZXR0aW5ncy5maWxlLnBhdGg7XG4gICAgICAgIGlmIChzZXR0aW5ncy5maWxlLnNob3VsZEJ1c3RDYWNoZSkge1xuICAgICAgICAgIGZpbGVQYXRoID0gdGhpcy5fYXBwbHlDYWNoZUJ1c3RlcihmaWxlUGF0aCk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdTcGVlZERldGFpbHMuc3RhcnQoKTtcblxuICAgICAgICBkb3dubG9hZC5zcmMgPSBmaWxlUGF0aDtcbiAgICAgIH1cbiAgICApLnBpcGUoXG4gICAgICBtZXJnZU1hcChcbiAgICAgICAgKG5ld1NwZWVkRGV0YWlsczpTcGVlZFRlc3RSZXN1bHRzTW9kZWx8bnVsbCkgPT4ge1xuICAgICAgICAgIGlmICh0eXBlb2YgYWxsRGV0YWlscyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGFsbERldGFpbHMgPSBbXTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBhbGxEZXRhaWxzLnB1c2gobmV3U3BlZWREZXRhaWxzKTtcblxuICAgICAgICAgIGlmIChzZXR0aW5ncy5pdGVyYXRpb25zID09PSAxKSB7XG4gICAgICAgICAgICBjb25zdCBjb3VudCA9IGFsbERldGFpbHMubGVuZ3RoO1xuICAgICAgICAgICAgbGV0IHRvdGFsID0gMDtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgIHRvdGFsICs9IGFsbERldGFpbHNbaV0uc3BlZWRCcHM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHNwZWVkQnBzID0gdG90YWwgLyBjb3VudDtcblxuICAgICAgICAgICAgcmV0dXJuIG9mKHNwZWVkQnBzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2V0dGluZ3MuaXRlcmF0aW9ucy0tO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZG93bmxvYWQoc2V0dGluZ3MsIGFsbERldGFpbHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBnZXRCcHMoc2V0dGluZ3M6U3BlZWRUZXN0U2V0dGluZ3NNb2RlbCk6T2JzZXJ2YWJsZTxudW1iZXJ8bnVsbD4ge1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShcbiAgICAgIChvYnNlcnZlcikgPT4ge1xuICAgICAgICB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0U2V0dGluZ3MgPSBuZXcgU3BlZWRUZXN0U2V0dGluZ3NNb2RlbCgpO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzLml0ZXJhdGlvbnMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgIHNldHRpbmdzLml0ZXJhdGlvbnMgPSBkZWZhdWx0U2V0dGluZ3MuaXRlcmF0aW9ucztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5maWxlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICBzZXR0aW5ncy5maWxlID0gZGVmYXVsdFNldHRpbmdzLmZpbGU7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0RmlsZVNldHRpbmdzID0gbmV3IFNwZWVkVGVzdEZpbGVNb2RlbCgpO1xuXG4gICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MuZmlsZS5wYXRoID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ25nLXNwZWVkLXRlc3Q6IEZpbGUgcGF0aCBpcyBtaXNzaW5nLicpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdzLmZpbGUuc2l6ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCduZy1zcGVlZC10ZXN0OiBGaWxlIHNpemUgaXMgbWlzc2luZy4nKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5maWxlLnNob3VsZEJ1c3RDYWNoZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBzZXR0aW5ncy5maWxlLnNob3VsZEJ1c3RDYWNoZSA9IGRlZmF1bHRGaWxlU2V0dGluZ3Muc2hvdWxkQnVzdENhY2hlO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5yZXRyeURlbGF5ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHNldHRpbmdzLnJldHJ5RGVsYXkgPSBkZWZhdWx0U2V0dGluZ3MucmV0cnlEZWxheTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLl9kb3dubG9hZChkZWVwQ29weShzZXR0aW5ncykpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgKHNwZWVkQnBzKSA9PiB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChzcGVlZEJwcyk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIDFcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZ2V0S2JwcyhzZXR0aW5nczpTcGVlZFRlc3RTZXR0aW5nc01vZGVsKTpPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLmdldEJwcyhzZXR0aW5ncykucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGJwcykgPT4ge1xuICAgICAgICAgIHJldHVybiBicHMgLyAxMDI0O1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGdldE1icHMoc2V0dGluZ3M6U3BlZWRUZXN0U2V0dGluZ3NNb2RlbCk6T2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRLYnBzKHNldHRpbmdzKS5waXBlKFxuICAgICAgbWFwKFxuICAgICAgICAoa3BicykgPT4ge1xuICAgICAgICAgIHJldHVybiBrcGJzIC8gMTAyNDtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBpc09ubGluZSgpOk9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBtZXJnZTxib29sZWFuPihcbiAgICAgIGZyb21FdmVudCh3aW5kb3csICdvZmZsaW5lJykucGlwZShcbiAgICAgICAgbWFwKFxuICAgICAgICAgICgpID0+IGZhbHNlXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICBmcm9tRXZlbnQod2luZG93LCAnb25saW5lJykucGlwZShcbiAgICAgICAgbWFwKFxuICAgICAgICAgICgpID0+IHRydWVcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIG5ldyBPYnNlcnZhYmxlKFxuICAgICAgICAoc3ViOk9ic2VydmVyPGJvb2xlYW4+KSA9PiB7XG4gICAgICAgICAgc3ViLm5leHQobmF2aWdhdG9yLm9uTGluZSk7XG4gICAgICAgICAgc3ViLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG59XG4iXX0=