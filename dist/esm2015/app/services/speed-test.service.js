import { Injectable } from '@angular/core';
import { fromEvent, merge, Observable, of } from 'rxjs';
import { mergeMap, map } from 'rxjs/operators';
import { FileDetailsModel } from '../models/file-details.model';
import { SpeedDetailsModel } from '../models/speed-details.model';
export class SpeedTestService {
    constructor() {
        this._applyCacheBuster = (path) => path + '?nnn=' + Math.random();
    }
    _download(iterations, fileDetails, allDetails) {
        return new Observable((observer) => {
            const newSpeedDetails = new SpeedDetailsModel(fileDetails.size);
            const download = new Image();
            download.onload = () => {
                newSpeedDetails.end();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            download.onerror = () => {
                newSpeedDetails.error();
                observer.next(newSpeedDetails);
                observer.complete();
            };
            let filePath = fileDetails.path;
            if (fileDetails.shouldBustCache) {
                filePath = this._applyCacheBuster(filePath);
            }
            newSpeedDetails.start();
            download.src = filePath;
        }).pipe(mergeMap((newSpeedDetails) => {
            if (typeof allDetails === 'undefined') {
                allDetails = [];
            }
            allDetails.push(newSpeedDetails);
            if (typeof iterations === 'undefined') {
                iterations = 3;
            }
            if (iterations === 1) {
                const count = allDetails.length;
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += allDetails[i].speedBps;
                }
                const speedBps = total / count;
                return of(speedBps);
            }
            else {
                return this._download(--iterations, fileDetails, allDetails);
            }
        }));
    }
    getBps(iterations, fileDetails) {
        return new Observable((observer) => {
            window.setTimeout(() => {
                if (typeof fileDetails === 'undefined') {
                    fileDetails = new FileDetailsModel();
                }
                else {
                    if (typeof fileDetails.path === 'undefined') {
                        console.error('ng-speed-test: File path is missing.');
                        return null;
                    }
                    if (typeof fileDetails.size === 'undefined') {
                        console.error('ng-speed-test: File size is missing.');
                        return null;
                    }
                    if (typeof fileDetails.shouldBustCache === 'undefined') {
                        fileDetails.shouldBustCache = true;
                    }
                    else {
                        fileDetails.shouldBustCache = fileDetails.shouldBustCache === true;
                    }
                }
                this._download(iterations, fileDetails).subscribe((speedBps) => {
                    observer.next(speedBps);
                    observer.complete();
                });
            }, 1);
        });
    }
    getKbps(iterations, fileDetails) {
        return this.getBps(iterations, fileDetails).pipe(map((bps) => {
            return bps / 1024;
        }));
    }
    getMbps(iterations, fileDetails) {
        return this.getKbps(iterations, fileDetails).pipe(map((kpbs) => {
            return kpbs / 1024;
        }));
    }
    isOnline() {
        return merge(fromEvent(window, 'offline').pipe(map(() => false)), fromEvent(window, 'online').pipe(map(() => true)), new Observable((sub) => {
            sub.next(navigator.onLine);
            sub.complete();
        }));
    }
}
SpeedTestService.decorators = [
    { type: Injectable }
];
SpeedTestService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlZWQtdGVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9qcnF1aWNrL2RldmVsb3BtZW50L2VuY291bnRpbmcvbmctc3BlZWQtdGVzdC9zcmMvIiwic291cmNlcyI6WyJhcHAvc2VydmljZXMvc3BlZWQtdGVzdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFekMsT0FBTyxFQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFZLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNoRSxPQUFPLEVBQUMsUUFBUSxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRTdDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQzlELE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLCtCQUErQixDQUFDO0FBR2hFLE1BQU0sT0FBTyxnQkFBZ0I7SUFDM0I7UUFJUSxzQkFBaUIsR0FBRyxDQUFDLElBQVcsRUFBVSxFQUFFLENBQUMsSUFBSSxHQUFHLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFGcEYsQ0FBQztJQUlPLFNBQVMsQ0FBQyxVQUFrQixFQUFFLFdBQTZCLEVBQUUsVUFBK0I7UUFDbEcsT0FBTyxJQUFJLFVBQVUsQ0FDbkIsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUNYLE1BQU0sZUFBZSxHQUFHLElBQUksaUJBQWlCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRWhFLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7WUFFN0IsUUFBUSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7Z0JBQ3JCLGVBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFFdEIsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDL0IsUUFBUSxDQUFDLFFBQVEsRUFBRSxD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cm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtmcm9tRXZlbnQsIG1lcmdlLCBPYnNlcnZhYmxlLCBPYnNlcnZlciwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttZXJnZU1hcCwgbWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7RmlsZURldGFpbHNNb2RlbH0gZnJvbSAnLi4vbW9kZWxzL2ZpbGUtZGV0YWlscy5tb2RlbCc7XG5pbXBvcnQge1NwZWVkRGV0YWlsc01vZGVsfSBmcm9tICcuLi9tb2RlbHMvc3BlZWQtZGV0YWlscy5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTcGVlZFRlc3RTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoKSB7XG5cbiAgfVxuXG4gIHByaXZhdGUgX2FwcGx5Q2FjaGVCdXN0ZXIgPSAocGF0aDpzdHJpbmcpOiBzdHJpbmcgPT4gcGF0aCArICc/bm5uPScgKyBNYXRoLnJhbmRvbSgpO1xuXG4gIHByaXZhdGUgX2Rvd25sb2FkKGl0ZXJhdGlvbnM/Om51bWJlciwgZmlsZURldGFpbHM/OkZpbGVEZXRhaWxzTW9kZWwsIGFsbERldGFpbHM/OlNwZWVkRGV0YWlsc01vZGVsW10pOk9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlPFNwZWVkRGV0YWlsc01vZGVsPihcbiAgICAgIChvYnNlcnZlcikgPT4ge1xuICAgICAgICBjb25zdCBuZXdTcGVlZERldGFpbHMgPSBuZXcgU3BlZWREZXRhaWxzTW9kZWwoZmlsZURldGFpbHMuc2l6ZSk7XG5cbiAgICAgICAgY29uc3QgZG93bmxvYWQgPSBuZXcgSW1hZ2UoKTtcblxuICAgICAgICBkb3dubG9hZC5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICAgICAgbmV3U3BlZWREZXRhaWxzLmVuZCgpO1xuXG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChuZXdTcGVlZERldGFpbHMpO1xuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgZG93bmxvYWQub25lcnJvciA9ICgpID0+IHtcbiAgICAgICAgICBuZXdTcGVlZERldGFpbHMuZXJyb3IoKTtcblxuICAgICAgICAgIG9ic2VydmVyLm5leHQobmV3U3BlZWREZXRhaWxzKTtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBmaWxlUGF0aCA9IGZpbGVEZXRhaWxzLnBhdGg7XG4gICAgICAgIGlmIChmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUpIHtcbiAgICAgICAgICBmaWxlUGF0aCA9IHRoaXMuX2FwcGx5Q2FjaGVCdXN0ZXIoZmlsZVBhdGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV3U3BlZWREZXRhaWxzLnN0YXJ0KCk7XG5cbiAgICAgICAgZG93bmxvYWQuc3JjID0gZmlsZVBhdGg7XG4gICAgICB9XG4gICAgKS5waXBlKFxuICAgICAgbWVyZ2VNYXAoXG4gICAgICAgIChuZXdTcGVlZERldGFpbHM6U3BlZWREZXRhaWxzTW9kZWx8bnVsbCkgPT4ge1xuICAgICAgICAgIGlmICh0eXBlb2YgYWxsRGV0YWlscyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGFsbERldGFpbHMgPSBbXTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBhbGxEZXRhaWxzLnB1c2gobmV3U3BlZWREZXRhaWxzKTtcblxuICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0aW9ucyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGl0ZXJhdGlvbnMgPSAzO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChpdGVyYXRpb25zID09PSAxKSB7XG4gICAgICAgICAgICBjb25zdCBjb3VudCA9IGFsbERldGFpbHMubGVuZ3RoO1xuICAgICAgICAgICAgbGV0IHRvdGFsID0gMDtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICAgIHRvdGFsICs9IGFsbERldGFpbHNbaV0uc3BlZWRCcHM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHNwZWVkQnBzID0gdG90YWwgLyBjb3VudDtcblxuICAgICAgICAgICAgcmV0dXJuIG9mKHNwZWVkQnBzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2Rvd25sb2FkKC0taXRlcmF0aW9ucywgZmlsZURldGFpbHMsIGFsbERldGFpbHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBnZXRCcHMoaXRlcmF0aW9ucz86bnVtYmVyLCBmaWxlRGV0YWlscz86RmlsZURldGFpbHNNb2RlbCk6T2JzZXJ2YWJsZTxudW1iZXJ8bnVsbD4ge1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShcbiAgICAgIChvYnNlcnZlcikgPT4ge1xuICAgICAgICB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGZpbGVEZXRhaWxzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICBmaWxlRGV0YWlscyA9IG5ldyBGaWxlRGV0YWlsc01vZGVsKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAodHlwZW9mIGZpbGVEZXRhaWxzLnBhdGggPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignbmctc3BlZWQtdGVzdDogRmlsZSBwYXRoIGlzIG1pc3NpbmcuJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgZmlsZURldGFpbHMuc2l6ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCduZy1zcGVlZC10ZXN0OiBGaWxlIHNpemUgaXMgbWlzc2luZy4nKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgZmlsZURldGFpbHMuc2hvdWxkQnVzdENhY2hlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUgPSBmaWxlRGV0YWlscy5zaG91bGRCdXN0Q2FjaGUgPT09IHRydWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5fZG93bmxvYWQoaXRlcmF0aW9ucywgZmlsZURldGFpbHMpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgKHNwZWVkQnBzKSA9PiB7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChzcGVlZEJwcyk7XG4gICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIDFcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZ2V0S2JwcyhpdGVyYXRpb25zPzpudW1iZXIsIGZpbGVEZXRhaWxzPzpGaWxlRGV0YWlsc01vZGVsKTpPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLmdldEJwcyhpdGVyYXRpb25zLCBmaWxlRGV0YWlscykucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGJwcykgPT4ge1xuICAgICAgICAgIHJldHVybiBicHMgLyAxMDI0O1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGdldE1icHMoaXRlcmF0aW9ucz86bnVtYmVyLCBmaWxlRGV0YWlscz86RmlsZURldGFpbHNNb2RlbCk6T2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRLYnBzKGl0ZXJhdGlvbnMsIGZpbGVEZXRhaWxzKS5waXBlKFxuICAgICAgbWFwKFxuICAgICAgICAoa3BicykgPT4ge1xuICAgICAgICAgIHJldHVybiBrcGJzIC8gMTAyNDtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBpc09ubGluZSgpOk9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBtZXJnZTxib29sZWFuPihcbiAgICAgIGZyb21FdmVudCh3aW5kb3csICdvZmZsaW5lJykucGlwZShcbiAgICAgICAgbWFwKFxuICAgICAgICAgICgpID0+IGZhbHNlXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICBmcm9tRXZlbnQod2luZG93LCAnb25saW5lJykucGlwZShcbiAgICAgICAgbWFwKFxuICAgICAgICAgICgpID0+IHRydWVcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIG5ldyBPYnNlcnZhYmxlKFxuICAgICAgICAoc3ViOk9ic2VydmVyPGJvb2xlYW4+KSA9PiB7XG4gICAgICAgICAgc3ViLm5leHQobmF2aWdhdG9yLm9uTGluZSk7XG4gICAgICAgICAgc3ViLmNvbXBsZXRlKCk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG59XG4iXX0=