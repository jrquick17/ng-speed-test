import { Injectable } from '@angular/core';
import { fromEvent, merge, Observable, of, throwError } from 'rxjs';
import { map, mergeMap, catchError, timeout } from 'rxjs/operators';
import { SpeedTestResultsModel } from '../models/speed-test-results.model';
import { SpeedTestSettingsModel } from '../models/speed-test-settings.model';
import * as i0 from "@angular/core";
export class SpeedTestService {
    constructor() {
        this.DEFAULT_TIMEOUT = 30000; // 30 seconds
    }
    applyCacheBuster(path) {
        const separator = path.includes('?') ? '&' : '?';
        return `${path}${separator}cache_bust=${Date.now()}_${Math.random()}`;
    }
    downloadTest(settings, allResults = []) {
        return new Observable(observer => {
            const testResult = new SpeedTestResultsModel(settings.file.size);
            // Use fetch API for better error handling and modern approach
            const abortController = new AbortController();
            let filePath = settings.file.path;
            if (settings.file.shouldBustCache) {
                filePath = this.applyCacheBuster(filePath);
            }
            testResult.start();
            fetch(filePath, {
                method: 'GET',
                signal: abortController.signal,
                cache: 'no-cache'
            })
                .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
                .then(() => {
                testResult.end();
                observer.next(testResult);
                observer.complete();
            })
                .catch(error => {
                console.warn('Speed test download failed:', error);
                testResult.error();
                const delay = settings.iterations !== 1 ? settings.retryDelay : 0;
                setTimeout(() => {
                    observer.next(testResult);
                    observer.complete();
                }, delay);
            });
            // Cleanup function
            return () => {
                abortController.abort();
            };
        }).pipe(timeout(this.DEFAULT_TIMEOUT), catchError(error => {
            console.error('Speed test timeout or error:', error);
            const failedResult = new SpeedTestResultsModel(settings.file.size);
            failedResult.error();
            return of(failedResult);
        }), mergeMap((testResult) => {
            allResults.push(testResult);
            if (settings.iterations === 1) {
                // Calculate average speed from all valid results
                const validResults = allResults.filter(result => result.speedBps > 0);
                if (validResults.length === 0) {
                    return throwError(() => new Error('All speed test iterations failed'));
                }
                const totalSpeed = validResults.reduce((sum, result) => sum + result.speedBps, 0);
                const averageSpeed = totalSpeed / validResults.length;
                return of(averageSpeed);
            }
            else {
                settings.iterations--;
                return this.downloadTest(settings, allResults);
            }
        }));
    }
    validateSettings(settings) {
        if (!settings.file?.path) {
            throw new Error('ng-speed-test: File path is required');
        }
        if (!settings.file?.size || settings.file.size <= 0) {
            throw new Error('ng-speed-test: Valid file size is required');
        }
        if (settings.iterations && settings.iterations < 1) {
            throw new Error('ng-speed-test: Iterations must be at least 1');
        }
    }
    /**
     * Get internet speed in bits per second (bps)
     */
    getBps(customSettings) {
        return new Observable(observer => {
            // Small delay to ensure proper initialization
            setTimeout(() => {
                const settings = new SpeedTestSettingsModel(customSettings);
                try {
                    this.validateSettings(settings);
                    this.downloadTest(settings).subscribe({
                        next: (speedBps) => {
                            observer.next(speedBps);
                            observer.complete();
                        },
                        error: (error) => {
                            observer.error(error);
                        }
                    });
                }
                catch (error) {
                    observer.error(error);
                }
            }, 1);
        });
    }
    /**
     * Get internet speed in kilobits per second (Kbps)
     */
    getKbps(settings) {
        return this.getBps(settings).pipe(map(bps => bps / 1024));
    }
    /**
     * Get internet speed in megabits per second (Mbps)
     */
    getMbps(settings) {
        return this.getKbps(settings).pipe(map(kbps => kbps / 1024));
    }
    /**
     * Get comprehensive speed test results
     */
    getSpeedTestResult(settings) {
        const startTime = Date.now();
        return this.getBps(settings).pipe(map(bps => ({
            bps,
            kbps: bps / 1024,
            mbps: bps / (1024 * 1024),
            duration: (Date.now() - startTime) / 1000
        })));
    }
    /**
     * Check if the browser is online
     */
    isOnline() {
        return merge(fromEvent(window, 'offline').pipe(map(() => false)), fromEvent(window, 'online').pipe(map(() => true)), of(navigator.onLine));
    }
    /**
     * Monitor network connection status
     */
    getNetworkStatus() {
        const getConnectionInfo = () => {
            const connection = navigator.connection ||
                navigator.mozConnection ||
                navigator.webkitConnection;
            return {
                isOnline: navigator.onLine,
                effectiveType: connection?.effectiveType,
                downlink: connection?.downlink
            };
        };
        return merge(fromEvent(window, 'offline').pipe(map(() => ({ ...getConnectionInfo(), isOnline: false }))), fromEvent(window, 'online').pipe(map(() => ({ ...getConnectionInfo(), isOnline: true }))), of(getConnectionInfo()));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.12", ngImport: i0, type: SpeedTestService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.12", ngImport: i0, type: SpeedTestService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.12", ngImport: i0, type: SpeedTestService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlZWQtdGVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NlcnZpY2VzL3NwZWVkLXRlc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMzRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQzs7QUFNN0UsTUFBTSxPQUFPLGdCQUFnQjtJQUd6QjtRQUZpQixvQkFBZSxHQUFHLEtBQUssQ0FBQyxDQUFDLGFBQWE7SUFFeEMsQ0FBQztJQUVSLGdCQUFnQixDQUFDLElBQVk7UUFDakMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFDakQsT0FBTyxHQUFHLElBQUksR0FBRyxTQUFTLGNBQWMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO0lBQzFFLENBQUM7SUFFTyxZQUFZLENBQUMsUUFBZ0MsRUFBRSxhQUFzQyxFQUFFO1FBQzNGLE9BQU8sSUFBSSxVQUFVLENBQXdCLFFBQVEsQ0FBQyxFQUFFO1lBQ3BELE1BQU0sVUFBVSxHQUFHLElBQUkscUJBQXFCLENBQUMsUUFBUSxDQUFDLElBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVsRSw4REFBOEQ7WUFDOUQsTUFB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QUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUMzRixTQUFTLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsaUJBQWlCLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQ3pGLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQzFCLENBQUM7SUFDTixDQUFDOytHQW5NUSxnQkFBZ0I7bUhBQWhCLGdCQUFnQixjQUZiLE1BQU07OzRGQUVULGdCQUFnQjtrQkFINUIsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGZyb21FdmVudCwgbWVyZ2UsIE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgbWVyZ2VNYXAsIGNhdGNoRXJyb3IsIHRpbWVvdXQgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBTcGVlZFRlc3RSZXN1bHRzTW9kZWwgfSBmcm9tICcuLi9tb2RlbHMvc3BlZWQtdGVzdC1yZXN1bHRzLm1vZGVsJztcclxuaW1wb3J0IHsgU3BlZWRUZXN0U2V0dGluZ3NNb2RlbCB9IGZyb20gJy4uL21vZGVscy9zcGVlZC10ZXN0LXNldHRpbmdzLm1vZGVsJztcclxuaW1wb3J0IHtTcGVlZFRlc3RSZXN1bHR9IGZyb20gJy4uL21vZGVscy9zcGVlZC10ZXN0LXJlc3VsdC5tb2RlbCc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFNwZWVkVGVzdFNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBERUZBVUxUX1RJTUVPVVQgPSAzMDAwMDsgLy8gMzAgc2Vjb25kc1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge31cclxuXHJcbiAgICBwcml2YXRlIGFwcGx5Q2FjaGVCdXN0ZXIocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBzZXBhcmF0b3IgPSBwYXRoLmluY2x1ZGVzKCc/JykgPyAnJicgOiAnPyc7XHJcbiAgICAgICAgcmV0dXJuIGAke3BhdGh9JHtzZXBhcmF0b3J9Y2FjaGVfYnVzdD0ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKX1gO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZG93bmxvYWRUZXN0KHNldHRpbmdzOiBTcGVlZFRlc3RTZXR0aW5nc01vZGVsLCBhbGxSZXN1bHRzOiBTcGVlZFRlc3RSZXN1bHRzTW9kZWxbXSA9IFtdKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8U3BlZWRUZXN0UmVzdWx0c01vZGVsPihvYnNlcnZlciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRlc3RSZXN1bHQgPSBuZXcgU3BlZWRUZXN0UmVzdWx0c01vZGVsKHNldHRpbmdzLmZpbGUhLnNpemUpO1xyXG5cclxuICAgICAgICAgICAgLy8gVXNlIGZldGNoIEFQSSBmb3IgYmV0dGVyIGVycm9yIGhhbmRsaW5nIGFuZCBtb2Rlcm4gYXBwcm9hY2hcclxuICAgICAgICAgICAgY29uc3QgYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGZpbGVQYXRoID0gc2V0dGluZ3MuZmlsZSEucGF0aDtcclxuICAgICAgICAgICAgaWYgKHNldHRpbmdzLmZpbGUhLnNob3VsZEJ1c3RDYWNoZSkge1xyXG4gICAgICAgICAgICAgICAgZmlsZVBhdGggPSB0aGlzLmFwcGx5Q2FjaGVCdXN0ZXIoZmlsZVBhdGgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0ZXN0UmVzdWx0LnN0YXJ0KCk7XHJcblxyXG4gICAgICAgICAgICBmZXRjaChmaWxlUGF0aCwge1xyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcclxuICAgICAgICAgICAgICAgIHNpZ25hbDogYWJvcnRDb250cm9sbGVyLnNpZ25hbCxcclxuICAgICAgICAgICAgICAgIGNhY2hlOiAnbm8tY2FjaGUnXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEhUVFAgJHtyZXNwb25zZS5zdGF0dXN9OiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5ibG9iKCk7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRlc3RSZXN1bHQuZW5kKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dCh0ZXN0UmVzdWx0KTtcclxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdTcGVlZCB0ZXN0IGRvd25sb2FkIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGVzdFJlc3VsdC5lcnJvcigpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWxheSA9IHNldHRpbmdzLml0ZXJhdGlvbnMgIT09IDEgPyBzZXR0aW5ncy5yZXRyeURlbGF5ISA6IDA7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRlc3RSZXN1bHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sIGRlbGF5KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gQ2xlYW51cCBmdW5jdGlvblxyXG4gICAgICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyLmFib3J0KCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSkucGlwZShcclxuICAgICAgICAgICAgdGltZW91dCh0aGlzLkRFRkFVTFRfVElNRU9VVCksXHJcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignU3BlZWQgdGVzdCB0aW1lb3V0IG9yIGVycm9yOicsIGVycm9yKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZFJlc3VsdCA9IG5ldyBTcGVlZFRlc3RSZXN1bHRzTW9kZWwoc2V0dGluZ3MuZmlsZSEuc2l6ZSk7XHJcbiAgICAgICAgICAgICAgICBmYWlsZWRSZXN1bHQuZXJyb3IoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihmYWlsZWRSZXN1bHQpO1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgbWVyZ2VNYXAoKHRlc3RSZXN1bHQ6IFNwZWVkVGVzdFJlc3VsdHNNb2RlbCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYWxsUmVzdWx0cy5wdXNoKHRlc3RSZXN1bHQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncy5pdGVyYXRpb25zID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGF2ZXJhZ2Ugc3BlZWQgZnJvbSBhbGwgdmFsaWQgcmVzdWx0c1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkUmVzdWx0cyA9IGFsbFJlc3VsdHMuZmlsdGVyKHJlc3VsdCA9PiByZXN1bHQuc3BlZWRCcHMgPiAwKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbGlkUmVzdWx0cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoKCkgPT4gbmV3IEVycm9yKCdBbGwgc3BlZWQgdGVzdCBpdGVyYXRpb25zIGZhaWxlZCcpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvdGFsU3BlZWQgPSB2YWxpZFJlc3VsdHMucmVkdWNlKChzdW0sIHJlc3VsdCkgPT4gc3VtICsgcmVzdWx0LnNwZWVkQnBzLCAwKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhdmVyYWdlU3BlZWQgPSB0b3RhbFNwZWVkIC8gdmFsaWRSZXN1bHRzLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGF2ZXJhZ2VTcGVlZCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLml0ZXJhdGlvbnMhLS07XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWRUZXN0KHNldHRpbmdzLCBhbGxSZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdmFsaWRhdGVTZXR0aW5ncyhzZXR0aW5nczogU3BlZWRUZXN0U2V0dGluZ3NNb2RlbCk6IHZvaWQge1xyXG4gICAgICAgIGlmICghc2V0dGluZ3MuZmlsZT8ucGF0aCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25nLXNwZWVkLXRlc3Q6IEZpbGUgcGF0aCBpcyByZXF1aXJlZCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCFzZXR0aW5ncy5maWxlPy5zaXplIHx8IHNldHRpbmdzLmZpbGUuc2l6ZSA8PSAwKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbmctc3BlZWQtdGVzdDogVmFsaWQgZmlsZSBzaXplIGlzIHJlcXVpcmVkJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc2V0dGluZ3MuaXRlcmF0aW9ucyAmJiBzZXR0aW5ncy5pdGVyYXRpb25zIDwgMSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25nLXNwZWVkLXRlc3Q6IEl0ZXJhdGlvbnMgbXVzdCBiZSBhdCBsZWFzdCAxJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGludGVybmV0IHNwZWVkIGluIGJpdHMgcGVyIHNlY29uZCAoYnBzKVxyXG4gICAgICovXHJcbiAgICBnZXRCcHMoY3VzdG9tU2V0dGluZ3M/OiBQYXJ0aWFsPFNwZWVkVGVzdFNldHRpbmdzTW9kZWw+KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4ge1xyXG4gICAgICAgICAgICAvLyBTbWFsbCBkZWxheSB0byBlbnN1cmUgcHJvcGVyIGluaXRpYWxpemF0aW9uXHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBuZXcgU3BlZWRUZXN0U2V0dGluZ3NNb2RlbChjdXN0b21TZXR0aW5ncyk7XHJcblxyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlU2V0dGluZ3Moc2V0dGluZ3MpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRvd25sb2FkVGVzdChzZXR0aW5ncykuc3Vic2NyaWJlKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dDogKHNwZWVkQnBzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHNwZWVkQnBzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDEpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGludGVybmV0IHNwZWVkIGluIGtpbG9iaXRzIHBlciBzZWNvbmQgKEticHMpXHJcbiAgICAgKi9cclxuICAgIGdldEticHMoc2V0dGluZ3M/OiBQYXJ0aWFsPFNwZWVkVGVzdFNldHRpbmdzTW9kZWw+KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRCcHMoc2V0dGluZ3MpLnBpcGUoXHJcbiAgICAgICAgICAgIG1hcChicHMgPT4gYnBzIC8gMTAyNClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGludGVybmV0IHNwZWVkIGluIG1lZ2FiaXRzIHBlciBzZWNvbmQgKE1icHMpXHJcbiAgICAgKi9cclxuICAgIGdldE1icHMoc2V0dGluZ3M/OiBQYXJ0aWFsPFNwZWVkVGVzdFNldHRpbmdzTW9kZWw+KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRLYnBzKHNldHRpbmdzKS5waXBlKFxyXG4gICAgICAgICAgICBtYXAoa2JwcyA9PiBrYnBzIC8gMTAyNClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGNvbXByZWhlbnNpdmUgc3BlZWQgdGVzdCByZXN1bHRzXHJcbiAgICAgKi9cclxuICAgIGdldFNwZWVkVGVzdFJlc3VsdChzZXR0aW5ncz86IFBhcnRpYWw8U3BlZWRUZXN0U2V0dGluZ3NNb2RlbD4pOiBPYnNlcnZhYmxlPFNwZWVkVGVzdFJlc3VsdD4ge1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmdldEJwcyhzZXR0aW5ncykucGlwZShcclxuICAgICAgICAgICAgbWFwKGJwcyA9PiAoe1xyXG4gICAgICAgICAgICAgICAgYnBzLFxyXG4gICAgICAgICAgICAgICAga2JwczogYnBzIC8gMTAyNCxcclxuICAgICAgICAgICAgICAgIG1icHM6IGJwcyAvICgxMDI0ICogMTAyNCksXHJcbiAgICAgICAgICAgICAgICBkdXJhdGlvbjogKERhdGUubm93KCkgLSBzdGFydFRpbWUpIC8gMTAwMFxyXG4gICAgICAgICAgICB9KSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2hlY2sgaWYgdGhlIGJyb3dzZXIgaXMgb25saW5lXHJcbiAgICAgKi9cclxuICAgIGlzT25saW5lKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgICAgIHJldHVybiBtZXJnZShcclxuICAgICAgICAgICAgZnJvbUV2ZW50KHdpbmRvdywgJ29mZmxpbmUnKS5waXBlKG1hcCgoKSA9PiBmYWxzZSkpLFxyXG4gICAgICAgICAgICBmcm9tRXZlbnQod2luZG93LCAnb25saW5lJykucGlwZShtYXAoKCkgPT4gdHJ1ZSkpLFxyXG4gICAgICAgICAgICBvZihuYXZpZ2F0b3Iub25MaW5lKVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBNb25pdG9yIG5ldHdvcmsgY29ubmVjdGlvbiBzdGF0dXNcclxuICAgICAqL1xyXG4gICAgZ2V0TmV0d29ya1N0YXR1cygpOiBPYnNlcnZhYmxlPHsgaXNPbmxpbmU6IGJvb2xlYW47IGVmZmVjdGl2ZVR5cGU/OiBzdHJpbmc7IGRvd25saW5rPzogbnVtYmVyIH0+IHtcclxuICAgICAgICBjb25zdCBnZXRDb25uZWN0aW9uSW5mbyA9ICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IChuYXZpZ2F0b3IgYXMgYW55KS5jb25uZWN0aW9uIHx8XHJcbiAgICAgICAgICAgICAgICAobmF2aWdhdG9yIGFzIGFueSkubW96Q29ubmVjdGlvbiB8fFxyXG4gICAgICAgICAgICAgICAgKG5hdmlnYXRvciBhcyBhbnkpLndlYmtpdENvbm5lY3Rpb247XHJcblxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgaXNPbmxpbmU6IG5hdmlnYXRvci5vbkxpbmUsXHJcbiAgICAgICAgICAgICAgICBlZmZlY3RpdmVUeXBlOiBjb25uZWN0aW9uPy5lZmZlY3RpdmVUeXBlLFxyXG4gICAgICAgICAgICAgICAgZG93bmxpbms6IGNvbm5lY3Rpb24/LmRvd25saW5rXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG1lcmdlKFxyXG4gICAgICAgICAgICBmcm9tRXZlbnQod2luZG93LCAnb2ZmbGluZScpLnBpcGUobWFwKCgpID0+ICh7IC4uLmdldENvbm5lY3Rpb25JbmZvKCksIGlzT25saW5lOiBmYWxzZSB9KSkpLFxyXG4gICAgICAgICAgICBmcm9tRXZlbnQod2luZG93LCAnb25saW5lJykucGlwZShtYXAoKCkgPT4gKHsgLi4uZ2V0Q29ubmVjdGlvbkluZm8oKSwgaXNPbmxpbmU6IHRydWUgfSkpKSxcclxuICAgICAgICAgICAgb2YoZ2V0Q29ubmVjdGlvbkluZm8oKSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==