{"version":3,"file":"ng-speed-test.js","sources":["../../src/app/models/speed-test-file.model.ts","../../src/app/models/speed-test-results.model.ts","../../src/app/models/speed-test-settings.model.ts","../../src/app/services/speed-test.service.ts","../../src/app/speed-test.module.ts","../../src/ng-speed-test.ts"],"sourcesContent":["export class SpeedTestFileModel {\n  public path:string = 'https://raw.githubusercontent.com/jrquick17/ng-speed-test/02c59e4afde67c35a5ba74014b91d44b33c0b3fe/demo/src/assets/5mb.jpg';\n  public shouldBustCache:boolean = true;\n  public size:number = 4952221;\n\n  // 408949 // 500kb\n  // 1197292 // 1mb\n  // 4952221 // 5mb\n  // 13848150 // 15mb\n\n  constructor() {\n\n  }\n}\n","export class SpeedTestResultsModel {\n  public duration:number  = 0;\n  public hasEnded:boolean = false;\n\n  public startTime:number = null;\n  public endTime:number = null;\n\n  public speedBps:number = 0;\n\n  constructor(\n    private fileSize:number\n  ) {\n\n  }\n\n  private _update():void {\n    if (this.endTime !== null) {\n      const milliseconds = this.endTime - this.startTime;\n      if (milliseconds !== 0) {\n        this.duration = milliseconds / 1000;\n      }\n\n      const bitsLoaded = this.fileSize * 8;\n\n      this.speedBps = bitsLoaded / this.duration;\n    }\n  }\n\n  end():void {\n    if (!this.hasEnded) {\n      this.hasEnded = true;\n\n      this.endTime = (new Date()).getTime();\n\n      this._update();\n    }\n  }\n\n  error():void {\n    if (!this.hasEnded) {\n      this.hasEnded = true;\n\n      this.endTime = null;\n\n      this._update();\n    }\n  }\n\n  start():void {\n    this.startTime = (new Date()).getTime();\n  }\n}\n","import {SpeedTestFileModel} from './speed-test-file.model';\n\nexport class SpeedTestSettingsModel {\n  public iterations?:number = 3;\n  public file?:SpeedTestFileModel = new SpeedTestFileModel();\n  public retryDelay?:number = 500;\n}\n","import {Injectable} from '@angular/core';\n\nimport {fromEvent, merge, Observable, Observer, of} from 'rxjs';\nimport {mergeMap, map} from 'rxjs/operators';\n\nimport {SpeedTestFileModel} from '../models/speed-test-file.model';\nimport {SpeedTestResultsModel} from '../models/speed-test-results.model';\nimport {SpeedTestSettingsModel} from '../models/speed-test-settings.model';\nimport {deepCopy} from '@angular-devkit/core';\n\n@Injectable()\nexport class SpeedTestService {\n  constructor() {\n\n  }\n\n  private _applyCacheBuster = (path:string): string => path + '?nnn=' + Math.random();\n\n  private _download(settings:SpeedTestSettingsModel, allDetails?:SpeedTestResultsModel[]):Observable<number> {\n    return new Observable<SpeedTestResultsModel>(\n      (observer) => {\n        const newSpeedDetails = new SpeedTestResultsModel(settings.file.size);\n\n        const download = new Image();\n\n        download.onload = () => {\n          newSpeedDetails.end();\n\n          observer.next(newSpeedDetails);\n          observer.complete();\n        };\n\n        download.onerror = () => {\n          newSpeedDetails.error();\n\n          let delay = 0;\n          if (settings.iterations !== 1) {\n            delay = settings.retryDelay;\n          }\n\n          window.setTimeout(\n            () => {\n              observer.next(newSpeedDetails);\n              observer.complete();\n            },\n            delay\n          );\n        };\n\n        let filePath = settings.file.path;\n        if (settings.file.shouldBustCache) {\n          filePath = this._applyCacheBuster(filePath);\n        }\n\n        newSpeedDetails.start();\n\n        download.src = filePath;\n      }\n    ).pipe(\n      mergeMap(\n        (newSpeedDetails:SpeedTestResultsModel|null) => {\n          if (typeof allDetails === 'undefined') {\n            allDetails = [];\n          }\n\n          allDetails.push(newSpeedDetails);\n\n          if (settings.iterations === 1) {\n            const count = allDetails.length;\n            let total = 0;\n\n            for (let i = 0; i < count; i++) {\n              total += allDetails[i].speedBps;\n            }\n\n            const speedBps = total / count;\n\n            return of(speedBps);\n          } else {\n            settings.iterations--;\n\n            return this._download(settings, allDetails);\n          }\n        }\n      )\n    );\n  }\n\n  getBps(settings:SpeedTestSettingsModel):Observable<number|null> {\n    return new Observable(\n      (observer) => {\n        window.setTimeout(\n          () => {\n            const defaultSettings = new SpeedTestSettingsModel();\n\n            if (typeof settings.iterations === 'undefined') {\n              settings.iterations = defaultSettings.iterations;\n            }\n\n            if (typeof settings.file === 'undefined') {\n              settings.file = defaultSettings.file;\n            } else {\n              const defaultFileSettings = new SpeedTestFileModel();\n\n              if (typeof settings.file.path === 'undefined') {\n                console.error('ng-speed-test: File path is missing.');\n\n                return null;\n              }\n\n              if (typeof settings.file.size === 'undefined') {\n                console.error('ng-speed-test: File size is missing.');\n\n                return null;\n              }\n\n              if (typeof settings.file.shouldBustCache === 'undefined') {\n                settings.file.shouldBustCache = defaultFileSettings.shouldBustCache;\n              }\n\n              if (typeof settings.retryDelay === 'undefined') {\n                settings.retryDelay = defaultSettings.retryDelay;\n              }\n            }\n\n            this._download(deepCopy(settings)).subscribe(\n              (speedBps) => {\n                observer.next(speedBps);\n                observer.complete();\n              }\n            );\n          },\n          1\n        );\n      }\n    );\n  }\n\n  getKbps(settings:SpeedTestSettingsModel):Observable<number> {\n    return this.getBps(settings).pipe(\n      map(\n        (bps) => {\n          return bps / 1024;\n        }\n      )\n    );\n  }\n\n  getMbps(settings:SpeedTestSettingsModel):Observable<number> {\n    return this.getKbps(settings).pipe(\n      map(\n        (kpbs) => {\n          return kpbs / 1024;\n        }\n      )\n    );\n  }\n\n  isOnline():Observable<boolean> {\n    return merge<boolean>(\n      fromEvent(window, 'offline').pipe(\n        map(\n          () => false\n        )\n      ),\n      fromEvent(window, 'online').pipe(\n        map(\n          () => true\n        )\n      ),\n      new Observable(\n        (sub:Observer<boolean>) => {\n          sub.next(navigator.onLine);\n          sub.complete();\n        }\n      )\n    );\n  }\n}\n","import {NgModule} from '@angular/core';\n\nimport {SpeedTestService} from './services/speed-test.service';\n\n@NgModule({\n  providers: [\n    SpeedTestService\n  ]\n})\nexport class SpeedTestModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './main';\n"],"names":[],"mappings":"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"}