{"version":3,"sources":["../../src/app/models/speed-test-file.model.ts","../../src/app/models/speed-test-results.model.ts","../../src/app/models/speed-test-settings.model.ts","../../src/app/services/speed-test.service.ts","../../src/app/speed-test.module.ts"],"names":["this","path","shouldBustCache","size","SpeedTestResultsModel","fileSize","duration","hasEnded","startTime","endTime","speedBps","prototype","_update","milliseconds","bitsLoaded","end","Date","getTime","error","start","iterations","file","SpeedTestFileModel","retryDelay","SpeedTestService","_applyCacheBuster","Math","random","_download","settings","allDetails","_this","Observable","observer","newSpeedDetails","download","Image","onload","next","complete","onerror","delay","window","setTimeout","filePath","src","pipe","mergeMap","push","count","length","total","i","of","getBps","defaultSettings","SpeedTestSettingsModel","defaultFileSettings","console","deepCopy","subscribe","getKbps","map","bps","getMbps","kpbs","isOnline","merge","fromEvent","sub","navigator","onLine","Injectable","NgModule","args","providers"],"mappings":"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","sourcesContent":["export class SpeedTestFileModel {\n  public path:string = 'https://raw.githubusercontent.com/jrquick17/ng-speed-test/02c59e4afde67c35a5ba74014b91d44b33c0b3fe/demo/src/assets/5mb.jpg';\n  public shouldBustCache:boolean = true;\n  public size:number = 4952221;\n\n  // 408949 // 500kb\n  // 1197292 // 1mb\n  // 4952221 // 5mb\n  // 13848150 // 15mb\n\n  constructor() {\n\n  }\n}\n","export class SpeedTestResultsModel {\n  public duration:number  = 0;\n  public hasEnded:boolean = false;\n\n  public startTime:number = null;\n  public endTime:number = null;\n\n  public speedBps:number = 0;\n\n  constructor(\n    private fileSize:number\n  ) {\n\n  }\n\n  private _update():void {\n    if (this.endTime !== null) {\n      const milliseconds = this.endTime - this.startTime;\n      if (milliseconds !== 0) {\n        this.duration = milliseconds / 1000;\n      }\n\n      const bitsLoaded = this.fileSize * 8;\n\n      this.speedBps = bitsLoaded / this.duration;\n    }\n  }\n\n  end():void {\n    if (!this.hasEnded) {\n      this.hasEnded = true;\n\n      this.endTime = (new Date()).getTime();\n\n      this._update();\n    }\n  }\n\n  error():void {\n    if (!this.hasEnded) {\n      this.hasEnded = true;\n\n      this.endTime = null;\n\n      this._update();\n    }\n  }\n\n  start():void {\n    this.startTime = (new Date()).getTime();\n  }\n}\n","import {SpeedTestFileModel} from './speed-test-file.model';\n\nexport class SpeedTestSettingsModel {\n  public iterations?:number = 3;\n  public file?:SpeedTestFileModel = new SpeedTestFileModel();\n  public retryDelay?:number = 500;\n}\n","import {Injectable} from '@angular/core';\n\nimport {fromEvent, merge, Observable, Observer, of} from 'rxjs';\nimport {mergeMap, map} from 'rxjs/operators';\n\nimport {SpeedTestFileModel} from '../models/speed-test-file.model';\nimport {SpeedTestResultsModel} from '../models/speed-test-results.model';\nimport {SpeedTestSettingsModel} from '../models/speed-test-settings.model';\nimport {deepCopy} from '@angular-devkit/core';\n\n@Injectable()\nexport class SpeedTestService {\n  constructor() {\n\n  }\n\n  private _applyCacheBuster = (path:string): string => path + '?nnn=' + Math.random();\n\n  private _download(settings:SpeedTestSettingsModel, allDetails?:SpeedTestResultsModel[]):Observable<number> {\n    return new Observable<SpeedTestResultsModel>(\n      (observer) => {\n        const newSpeedDetails = new SpeedTestResultsModel(settings.file.size);\n\n        const download = new Image();\n\n        download.onload = () => {\n          newSpeedDetails.end();\n\n          observer.next(newSpeedDetails);\n          observer.complete();\n        };\n\n        download.onerror = () => {\n          newSpeedDetails.error();\n\n          let delay = 0;\n          if (settings.iterations !== 1) {\n            delay = settings.retryDelay;\n          }\n\n          window.setTimeout(\n            () => {\n              observer.next(newSpeedDetails);\n              observer.complete();\n            },\n            delay\n          );\n        };\n\n        let filePath = settings.file.path;\n        if (settings.file.shouldBustCache) {\n          filePath = this._applyCacheBuster(filePath);\n        }\n\n        newSpeedDetails.start();\n\n        download.src = filePath;\n      }\n    ).pipe(\n      mergeMap(\n        (newSpeedDetails:SpeedTestResultsModel|null) => {\n          if (typeof allDetails === 'undefined') {\n            allDetails = [];\n          }\n\n          allDetails.push(newSpeedDetails);\n\n          if (settings.iterations === 1) {\n            const count = allDetails.length;\n            let total = 0;\n\n            for (let i = 0; i < count; i++) {\n              total += allDetails[i].speedBps;\n            }\n\n            const speedBps = total / count;\n\n            return of(speedBps);\n          } else {\n            settings.iterations--;\n\n            return this._download(settings, allDetails);\n          }\n        }\n      )\n    );\n  }\n\n  getBps(settings:SpeedTestSettingsModel):Observable<number|null> {\n    return new Observable(\n      (observer) => {\n        window.setTimeout(\n          () => {\n            const defaultSettings = new SpeedTestSettingsModel();\n\n            if (typeof settings.iterations === 'undefined') {\n              settings.iterations = defaultSettings.iterations;\n            }\n\n            if (typeof settings.file === 'undefined') {\n              settings.file = defaultSettings.file;\n            } else {\n              const defaultFileSettings = new SpeedTestFileModel();\n\n              if (typeof settings.file.path === 'undefined') {\n                console.error('ng-speed-test: File path is missing.');\n\n                return null;\n              }\n\n              if (typeof settings.file.size === 'undefined') {\n                console.error('ng-speed-test: File size is missing.');\n\n                return null;\n              }\n\n              if (typeof settings.file.shouldBustCache === 'undefined') {\n                settings.file.shouldBustCache = defaultFileSettings.shouldBustCache;\n              }\n\n              if (typeof settings.retryDelay === 'undefined') {\n                settings.retryDelay = defaultSettings.retryDelay;\n              }\n            }\n\n            this._download(deepCopy(settings)).subscribe(\n              (speedBps) => {\n                observer.next(speedBps);\n                observer.complete();\n              }\n            );\n          },\n          1\n        );\n      }\n    );\n  }\n\n  getKbps(settings:SpeedTestSettingsModel):Observable<number> {\n    return this.getBps(settings).pipe(\n      map(\n        (bps) => {\n          return bps / 1024;\n        }\n      )\n    );\n  }\n\n  getMbps(settings:SpeedTestSettingsModel):Observable<number> {\n    return this.getKbps(settings).pipe(\n      map(\n        (kpbs) => {\n          return kpbs / 1024;\n        }\n      )\n    );\n  }\n\n  isOnline():Observable<boolean> {\n    return merge<boolean>(\n      fromEvent(window, 'offline').pipe(\n        map(\n          () => false\n        )\n      ),\n      fromEvent(window, 'online').pipe(\n        map(\n          () => true\n        )\n      ),\n      new Observable(\n        (sub:Observer<boolean>) => {\n          sub.next(navigator.onLine);\n          sub.complete();\n        }\n      )\n    );\n  }\n}\n","import {NgModule} from '@angular/core';\n\nimport {SpeedTestService} from './services/speed-test.service';\n\n@NgModule({\n  providers: [\n    SpeedTestService\n  ]\n})\nexport class SpeedTestModule {}\n"]}