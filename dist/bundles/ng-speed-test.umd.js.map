{"version":3,"file":"ng-speed-test.umd.js","sources":["../../src/app/models/file-details.model.ts","../../src/app/models/speed-details.model.ts","../../src/app/services/speed-test.service.ts","../../src/app/speed-test.module.ts","../../src/ng-speed-test.ts"],"sourcesContent":["export class FileDetailsModel {\n  public path:string = 'https://raw.githubusercontent.com/jrquick17/ng-speed-test/02c59e4afde67c35a5ba74014b91d44b33c0b3fe/demo/src/assets/5mb.jpg';\n  public shouldBustCache:boolean = true;\n  public size:number = 4952221;\n\n  // 408949 // 500kb\n  // 1197292 // 1mb\n  // 4952221 // 5mb\n  // 13848150 // 15mb\n\n  constructor() {\n\n  }\n}\n","export class SpeedDetailsModel {\n  public duration:number  = 0;\n  public hasEnded:boolean = false;\n\n  public startTime:number = null;\n  public endTime:number = null;\n\n  public speedBps:number = 0;\n\n  constructor(\n    private fileSize:number\n  ) {\n\n  }\n\n  private _update():void {\n    if (this.endTime !== null) {\n      const milliseconds = this.endTime - this.startTime;\n      if (milliseconds !== 0) {\n        this.duration = milliseconds / 1000;\n      }\n\n      const bitsLoaded = this.fileSize * 8;\n\n      this.speedBps = bitsLoaded / this.duration;\n    }\n  }\n\n  end():void {\n    if (!this.hasEnded) {\n      this.hasEnded = true;\n\n      this.endTime = (new Date()).getTime();\n\n      this._update();\n    }\n  }\n\n  error():void {\n    if (!this.hasEnded) {\n      this.hasEnded = true;\n\n      this.endTime = null;\n\n      this._update();\n    }\n  }\n\n  start():void {\n    this.startTime = (new Date()).getTime();\n  }\n}\n","import {Injectable} from '@angular/core';\n\nimport {Observable, of} from 'rxjs';\nimport {mergeMap, map} from 'rxjs/operators';\nimport {FileDetailsModel} from '../models/file-details.model';\nimport {SpeedDetailsModel} from '../models/speed-details.model';\n\n@Injectable()\nexport class SpeedTestService {\n  constructor() {\n\n  }\n\n  private _applyCacheBuster = (path:string): string => path + '?nnn=' + Math.random();\n\n  private _download(iterations?:number, fileDetails?:FileDetailsModel, allDetails?:SpeedDetailsModel[]):Observable<number> {\n    return new Observable<SpeedDetailsModel>(\n      (observer) => {\n        const newSpeedDetails = new SpeedDetailsModel(fileDetails.size);\n\n        const download = new Image();\n\n        download.onload = () => {\n          newSpeedDetails.end();\n\n          observer.next(newSpeedDetails);\n          observer.complete();\n        };\n\n        download.onerror = () => {\n          newSpeedDetails.error();\n\n          observer.next(newSpeedDetails);\n          observer.complete();\n        };\n\n        let filePath = fileDetails.path;\n        if (fileDetails.shouldBustCache) {\n          filePath = this._applyCacheBuster(filePath);\n        }\n\n        newSpeedDetails.start();\n\n        download.src = filePath;\n      }\n    ).pipe(\n      mergeMap(\n        (newSpeedDetails:SpeedDetailsModel|null) => {\n          if (typeof allDetails === 'undefined') {\n            allDetails = [];\n          }\n\n          allDetails.push(newSpeedDetails);\n\n          if (typeof iterations === 'undefined') {\n            iterations = 3;\n          }\n\n          if (iterations === 1) {\n            const count = allDetails.length;\n            let total = 0;\n\n            for (let i = 0; i < count; i++) {\n              total += allDetails[i].speedBps;\n            }\n\n            const speedBps = total / count;\n\n            return of(speedBps);\n          } else {\n            return this._download(--iterations, fileDetails, allDetails);\n          }\n        }\n      )\n    );\n  }\n\n  getBps(iterations?:number, fileDetails?:FileDetailsModel):Observable<number|null> {\n    return new Observable(\n      (observer) => {\n        window.setTimeout(\n          () => {\n            if (typeof fileDetails === 'undefined') {\n              fileDetails = new FileDetailsModel();\n            } else {\n              if (typeof fileDetails.path === 'undefined') {\n                console.error('ng-speed-test: File path is missing.');\n\n                return null;\n              }\n\n              if (typeof fileDetails.size === 'undefined') {\n                console.error('ng-speed-test: File size is missing.');\n\n                return null;\n              }\n\n              if (typeof fileDetails.shouldBustCache === 'undefined') {\n                fileDetails.shouldBustCache = true;\n              } else {\n                fileDetails.shouldBustCache = fileDetails.shouldBustCache === true;\n              }\n            }\n\n            this._download(iterations, fileDetails).subscribe(\n              (speedBps) => {\n                observer.next(speedBps);\n                observer.complete();\n              }\n            );\n          },\n          1\n        );\n      }\n    );\n  }\n\n  getKbps(iterations?:number, fileDetails?:FileDetailsModel):Observable<number> {\n    return this.getBps(iterations, fileDetails).pipe(\n      map(\n        (bps) => {\n          return bps / 1024;\n        }\n      )\n    );\n  }\n\n  getMbps(iterations?:number, fileDetails?:FileDetailsModel):Observable<number> {\n    return this.getKbps(iterations, fileDetails).pipe(\n      map(\n        (kpbs) => {\n          return kpbs / 1024;\n        }\n      )\n    );\n  }\n}\n","import {NgModule} from '@angular/core';\n\nimport {SpeedTestService} from './services/speed-test.service';\n\n@NgModule({\n  providers: [\n    SpeedTestService\n  ]\n})\nexport class SpeedTestModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './main';\n"],"names":["Observable","mergeMap","of","map","Injectable","NgModule"],"mappings":";;;;;;;;;;;QAUE;YATO,SAAI,GAAU,4HAA4H,CAAC;YAC3I,oBAAe,GAAW,IAAI,CAAC;YAC/B,SAAI,GAAU,OAAO,CAAC;SAS5B;+BACF;KAAA;;ICbD;QASE,2BACU,QAAe;YAAf,aAAQ,GAAR,QAAQ,CAAO;YATlB,aAAQ,GAAW,CAAC,CAAC;YACrB,aAAQ,GAAW,KAAK,CAAC;YAEzB,cAAS,GAAU,IAAI,CAAC;YACxB,YAAO,GAAU,IAAI,CAAC;YAEtB,aAAQ,GAAU,CAAC,CAAC;SAM1B;QAEO,mCAAO,GAAP;YACN,IAAI,IAAI,CAAC,OAAO,KAAK,IAAI,EAAE;gBACzB,IAAM,YAAY,GAAG,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC;gBACnD,IAAI,YAAY,KAAK,CAAC,EAAE;oBACtB,IAAI,CAAC,QAAQ,GAAG,YAAY,GAAG,IAAI,CAAC;iBACrC;gBAED,IAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAC;gBAErC,IAAI,CAAC,QAAQ,GAAG,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC;aAC5C;SACF;QAED,+BAAG,GAAH;YACE,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gBAClB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;gBAErB,IAAI,CAAC,OAAO,GAAG,CAAC,IAAI,IAAI,EAAE,EAAE,OAAO,EAAE,CAAC;gBAEtC,IAAI,CAAC,OAAO,EAAE,CAAC;aAChB;SACF;QAED,iCAAK,GAAL;YACE,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;gBAClB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;gBAErB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;gBAEpB,IAAI,CAAC,OAAO,EAAE,CAAC;aAChB;SACF;QAED,iCAAK,GAAL;YACE,IAAI,CAAC,SAAS,GAAG,CAAC,IAAI,IAAI,EAAE,EAAE,OAAO,EAAE,CAAC;SACzC;gCACF;KAAA;;;QC1CC;YAIQ,sBAAiB,GAAG,UAAC,IAAW,IAAa,OAAA,IAAI,GAAG,OAAO,GAAG,IAAI,CAAC,MAAM,EAAE,GAAA,CAAC;SAFnF;QAIO,oCAAS,GAAT,UAAU,UAAkB,EAAE,WAA6B,EAAE,UAA+B;YAA5F,iBA4DP;YA3DC,OAAO,IAAIA,eAAU,CACnB,UAAC,QAAQ;gBACP,IAAM,eAAe,GAAG,IAAI,iBAAiB,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;gBAEhE,IAAM,QAAQ,GAAG,IAAI,KAAK,EAAE,CAAC;gBAE7B,QAAQ,CAAC,MAAM,GAAG;oBAChB,eAAe,CAAC,GAAG,EAAE,CAAC;oBAEtB,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;oBAC/B,QAAQ,CAAC,QAAQ,EAAE,CAAC;iBACrB,CAAC;gBAEF,QAAQ,CAAC,OAAO,GAAG;oBACjB,eAAe,CAAC,KAAK,EAAE,CAAC;oBAExB,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;oBAC/B,QAAQ,CAAC,QAAQ,EAAE,CAAC;iBACrB,CAAC;gBAEF,IAAI,QAAQ,GAAG,WAAW,CAAC,IAAI,CAAC;gBAChC,IAAI,WAAW,CAAC,eAAe,EAAE;oBAC/B,QAAQ,GAAG,KAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;iBAC7C;gBAED,eAAe,CAAC,KAAK,EAAE,CAAC;gBAExB,QAAQ,CAAC,GAAG,GAAG,QAAQ,CAAC;aACzB,CACF,CAAC,IAAI,CACJC,kBAAQ,CACN,UAAC,eAAsC;gBACrC,IAAI,OAAO,UAAU,KAAK,WAAW,EAAE;oBACrC,UAAU,GAAG,EAAE,CAAC;iBACjB;gBAED,UAAU,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;gBAEjC,IAAI,OAAO,UAAU,KAAK,WAAW,EAAE;oBACrC,UAAU,GAAG,CAAC,CAAC;iBAChB;gBAED,IAAI,UAAU,KAAK,CAAC,EAAE;oBACpB,IAAM,KAAK,GAAG,UAAU,CAAC,MAAM,CAAC;oBAChC,IAAI,KAAK,GAAG,CAAC,CAAC;oBAEd,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,EAAE,EAAE;wBAC9B,KAAK,IAAI,UAAU,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC;qBACjC;oBAED,IAAM,QAAQ,GAAG,KAAK,GAAG,KAAK,CAAC;oBAE/B,OAAOC,OAAE,CAAC,QAAQ,CAAC,CAAC;iBACrB;qBAAM;oBACL,OAAO,KAAI,CAAC,SAAS,CAAC,EAAE,UAAU,EAAE,WAAW,EAAE,UAAU,CAAC,CAAC;iBAC9D;aACF,CACF,CACF,CAAC;SACH;QAED,iCAAM,GAAN,UAAO,UAAkB,EAAE,WAA6B;YAAxD,iBAsCC;YArCC,OAAO,IAAIF,eAAU,CACnB,UAAC,QAAQ;gBACP,MAAM,CAAC,UAAU,CACf;oBACE,IAAI,OAAO,WAAW,KAAK,WAAW,EAAE;wBACtC,WAAW,GAAG,IAAI,gBAAgB,EAAE,CAAC;qBACtC;yBAAM;wBACL,IAAI,OAAO,WAAW,CAAC,IAAI,KAAK,WAAW,EAAE;4BAC3C,OAAO,CAAC,KAAK,CAAC,sCAAsC,CAAC,CAAC;4BAEtD,OAAO,IAAI,CAAC;yBACb;wBAED,IAAI,OAAO,WAAW,CAAC,IAAI,KAAK,WAAW,EAAE;4BAC3C,OAAO,CAAC,KAAK,CAAC,sCAAsC,CAAC,CAAC;4BAEtD,OAAO,IAAI,CAAC;yBACb;wBAED,IAAI,OAAO,WAAW,CAAC,eAAe,KAAK,WAAW,EAAE;4BACtD,WAAW,CAAC,eAAe,GAAG,IAAI,CAAC;yBACpC;6BAAM;4BACL,WAAW,CAAC,eAAe,GAAG,WAAW,CAAC,eAAe,KAAK,IAAI,CAAC;yBACpE;qBACF;oBAED,KAAI,CAAC,SAAS,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC,SAAS,CAC/C,UAAC,QAAQ;wBACP,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;wBACxB,QAAQ,CAAC,QAAQ,EAAE,CAAC;qBACrB,CACF,CAAC;iBACH,EACD,CAAC,CACF,CAAC;aACH,CACF,CAAC;SACH;QAED,kCAAO,GAAP,UAAQ,UAAkB,EAAE,WAA6B;YACvD,OAAO,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC,IAAI,CAC9CG,aAAG,CACD,UAAC,GAAG;gBACF,OAAO,GAAG,GAAG,IAAI,CAAC;aACnB,CACF,CACF,CAAC;SACH;QAED,kCAAO,GAAP,UAAQ,UAAkB,EAAE,WAA6B;YACvD,OAAO,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC,IAAI,CAC/CA,aAAG,CACD,UAAC,IAAI;gBACH,OAAO,IAAI,GAAG,IAAI,CAAC;aACpB,CACF,CACF,CAAC;SACH;;;;gBAhIFC,eAAU;;;;;QCEX;;;;;gBALCC,aAAQ,SAAC;oBACR,SAAS,EAAE;wBACT,gBAAgB;qBACjB;iBACF;;;ICRD;;;;;;;;;;;;;;"}